<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SnapChef - AI Recipe Generator & Meal Planner</title>
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Scan ingredients, get instant AI recipes & nutrition analysis. Free meal planning app.">
    <meta name="keywords" content="recipe generator, meal planner, calorie counter, ingredient scanner, AI cooking">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        html {
            overflow-x: hidden !important;
            width: 100vw;
            max-width: 100vw;
        }
        body {
            overflow-x: hidden !important;
            width: 100vw;
            max-width: 100vw;
            position: relative;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #2D6A4F;
            --accent: #14b8a6;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #2D6A4F;
            --bg-light: #FAFAF7;
            --bg-dark: #121214;
            --card-light: #ffffff;
            --card-dark: #1C1C22;
            --text-light: #1A1A1E;
            --text-dark: #ECECED;
            --text-muted: #8E8E93;
            --border-light: #EBEBEA;
            --border-dark: #2C2C34;
            --premium-gold: #14b8a6;
            --glass-light: rgba(255, 255, 255, 0.85);
            --glass-dark: rgba(28, 28, 34, 0.85);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-xl: 0 16px 40px rgba(0,0,0,0.1);
            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --radius-xl: 24px;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            overflow-x: hidden;
            overscroll-behavior: none;
            -webkit-text-size-adjust: 100%;
        }
        * {
            max-width: 100vw;
        }
        /* ===== PERFORMANCE OPTIMIZATIONS ===== */
        @media (max-width: 768px) {
            * {
                -webkit-transform: translateZ(0);
            }
            .container {
                transform: translateZ(0);
                backface-visibility: hidden;
            }
        }
        .tab-content {
            will-change: auto;
        }
        .tab-content.active {
            will-change: contents;
        }


        body {
            background: #F5F4F0;
            background-attachment: fixed;
            min-height: 100vh;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        body.dark-mode {
            background: #121214;
        }

        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, #6366f1 0%, #4f46e5 40%, #4338ca 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }

        .splash-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            /* animation removed for performance */
        }

        @keyframes pulse-bg {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .splash-logo {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            z-index: 1;
        }

        .splash-logo svg {
            width: 56px;
            height: 56px;
            color: #6366f1;
        }

        .splash-title {
            color: white;
            font-size: 38px;
            font-weight: 800;
            margin-top: 24px;
            letter-spacing: -0.5px;
            animation: fadeInUp 0.8s 0.2s both;
            position: relative;
            z-index: 1;
        }

        .splash-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 15px;
            font-weight: 500;
            margin-top: 8px;
            animation: fadeInUp 0.8s 0.4s both;
            position: relative;
            z-index: 1;
        }

        .splash-loader {
            width: 44px;
            height: 44px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-top: 48px;
            position: relative;
            z-index: 1;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Onboarding */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--card-light);
            z-index: 9000;
            display: none;
            flex-direction: column;
        }

        .onboarding.active {
            display: flex;
        }

        body.dark-mode .onboarding {
            background: var(--card-dark);
        }

        .onboarding-slides {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .onboarding-slide {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            text-align: center;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.2s;
        }

        .onboarding-slide.active {
            opacity: 1;
            transform: translateX(0);
        }

        .onboarding-slide.prev {
            transform: translateX(-100%);
        }

        .onboarding-icon {
            font-size: 100px;
            margin-bottom: 30px;
        }

        .onboarding-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 15px;
        }

        body.dark-mode .onboarding-title {
            color: var(--text-dark);
        }

        .onboarding-desc {
            font-size: 16px;
            color: #64748b;
            line-height: 1.6;
            max-width: 320px;
        }

        .onboarding-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px;
        }

        .onboarding-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border-light);
            transition: all 0.3s;
        }

        .onboarding-dot.active {
            background: var(--primary);
            width: 30px;
            border-radius: 5px;
        }

        .onboarding-btns {
            padding: 20px 30px 40px;
            display: flex;
            gap: 15px;
        }

        .onboarding-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .onboarding-btn.skip {
            background: var(--bg-light);
            color: var(--text-light);
        }

        body.dark-mode .onboarding-btn.skip {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .onboarding-btn.next {
            background: var(--primary);
            color: white;
        }

        /* App Container */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overflow-x: hidden;
            padding: 0;
            max-width: 100vw;
            position: relative;
        }

        @media (min-width: 640px) {
            .app-container {
                padding: 10px 10px 0;
            }
        }

        .container {
            flex: 1;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: #FAFAF7;
            border-radius: 0;
            padding: 16px 18px 260px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            will-change: scroll-position;
            -ms-overflow-style: -ms-autohiding-scrollbar;
            touch-action: pan-y;
        }

        @media (min-width: 640px) {
            .container {
                max-width: 640px;
                border-radius: 32px 32px 0 0;
                padding: 24px 20px 220px;
                box-shadow: 0 -10px 60px rgba(0,0,0,0.15);
            }
        }
        @media (min-width: 768px) {
            .container {
                max-width: 720px;
            }
        }

        body.dark-mode .container {
            background: #1C1C22;
        }

        /* Subscription Banner */
        .subscription-banner {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            padding: 16px 18px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            max-width: 100%;
        }
        .subscription-banner::before {
            content: '';
            position: absolute;
            top: 0;
            right: -20px;
            width: 40px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212,168,83,0.15), transparent);
            transform: skewX(-15deg);
        }

        .subscription-banner:hover {
            transform: scale(1.02);
        }

        .subscription-banner.hidden {
            display: none;
        }

        .sub-icon {
            font-size: 28px;
        }

        .sub-text {
            flex: 1;
        }

        .sub-title {
            font-size: 14px;
            font-weight: 700;
            color: #a5b4fc;
        }

        .sub-desc {
            font-size: 12px;
            color: #0d9488;
        }

        .sub-btn {
            background: #14b8a6;
            color: #1A1A1E;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: none;
        }

        /* Usage Counter */
        .usage-counter {
            background: var(--card-light);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }

        body.dark-mode .usage-counter {
            background: var(--bg-dark);
        }

        .usage-counter.hidden {
            display: none;
        }

        .usage-text {
            color: var(--text-light);
        }

        body.dark-mode .usage-text {
            color: var(--text-dark);
        }

        .usage-bar {
            width: 100px;
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
        }

        body.dark-mode .usage-bar {
            background: var(--border-dark);
        }

        .usage-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        .usage-fill.warning {
            background: var(--warning);
        }

        .usage-fill.danger {
            background: var(--danger);
        }

        /* Credits Display */
        .credits-display {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--accent);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            color: #78350f;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .credits-display:hover {
            transform: scale(1.05);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .logo-icon i {
            width: 22px;
            height: 22px;
        }

        h1 {
            color: var(--text-light);
            font-size: 22px;
        }

        body.dark-mode h1 {
            color: var(--text-dark);
        }

        .premium-badge {
            background: var(--accent);
            color: #78350f;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        .header-btns {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            background: var(--bg-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
        }

        .icon-btn i {
            width: 20px;
            height: 20px;
        }

        body.dark-mode .icon-btn {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .icon-btn:hover {
            transform: scale(1.08);
            background: var(--primary);
            color: white;
        }

        /* Language Selector */
        .lang-selector {
            position: relative;
        }

        .lang-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-light);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            display: none;
            z-index: 100;
            min-width: 120px;
        }

        body.dark-mode .lang-dropdown {
            background: var(--card-dark);
        }

        .lang-dropdown.show {
            display: block;
        }

        .lang-option {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .lang-option {
            color: var(--text-dark);
        }

        .lang-option:hover {
            background: var(--bg-light);
        }

        body.dark-mode .lang-option:hover {
            background: var(--bg-dark);
        }

        .lang-option.active {
            background: rgba(16,163,127,0.1);
            color: var(--primary);
        }

        /* Voice Button */
        .voice-active {
            background: var(--danger) !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Voice Indicator */
        .voice-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #fca5a5;
        }

        .voice-indicator.active {
            display: flex;
        }

        body.dark-mode .voice-indicator {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            border-color: #dc2626;
        }

        .voice-indicator-dot {
            width: 12px;
            height: 12px;
            background: var(--danger);
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .voice-indicator-text {
            color: #991b1b;
            font-size: 14px;
            font-weight: 500;
        }

        body.dark-mode .voice-indicator-text {
            color: #fca5a5;
        }

        /* Offline Indicator */
        .offline-indicator {
            display: none;
            background: #fef3c7;
            color: #92400e;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
            align-items: center;
            gap: 8px;
        }

        .offline-indicator.show {
            display: flex;
        }

        body.dark-mode .offline-indicator {
            background: #78350f;
            color: #fde68a;
        }

        /* API Section */
        .api-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 15px;
            border: 1px solid #bbf7d0;
        }

        body.dark-mode .api-section {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border-color: #047857;
        }

        .api-section label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark-mode .api-section label {
            color: var(--text-dark);
        }

        .badge {
            background: var(--primary);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 10px;
            margin-left: 8px;
        }

        .api-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            margin-top: 8px;
            font-size: 13px;
            background: white;
        }

        body.dark-mode .api-input {
            background: var(--bg-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .api-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .api-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .api-hint {
            font-size: 11px;
            color: #64748b;
            flex: 1;
        }

        .api-hint a {
            color: var(--primary);
            text-decoration: none;
        }

        .test-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .test-btn:hover {
            background: var(--primary-dark);
        }

        .clear-key-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .api-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            display: none;
        }

        .api-status.success {
            background: #d1fae5;
            color: #065f46;
            display: block;
        }

        .api-status.error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }

        body.dark-mode .api-status.success {
            background: #064e3b;
            color: #6ee7b7;
        }

        body.dark-mode .api-status.error {
            background: #7f1d1d;
            color: #fca5a5;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Upload Section */
        .upload-section {
            background: var(--card-light);
            border-radius: var(--radius-lg);
            padding: 28px 20px;
            text-align: center;
            border: 1px solid var(--border-light);
            margin-bottom: 20px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .upload-section::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: var(--radius-lg);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .upload-section:hover::before {
            opacity: 0.15;
        }

        .upload-section:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        }

        body.dark-mode .upload-section {
            background: linear-gradient(135deg, #1e1e2e 0%, #252538 100%);
            border-color: var(--border-dark);
        }

        body.dark-mode .upload-section:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #252538 0%, #2d2d44 100%);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .upload-icon i {
            width: 32px;
            height: 32px;
        }

        .upload-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        body.dark-mode .upload-title {
            color: var(--text-dark);
        }

        .upload-subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .upload-btns {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .upload-btn {
            padding: 11px 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
            max-width: calc(50% - 4px);
        }

        .upload-btn.primary {
            background: var(--primary);
            color: white;
        }

        .upload-btn.secondary {
            background: var(--text-light);
            color: white;
        }

        body.dark-mode .upload-btn.secondary {
            background: #3C3C44;
        }

        .upload-btn.tertiary {
            background: var(--secondary);
            color: white;
        }

        .upload-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .upload-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .file-input {
            display: none;
        }

        /* Image Preview */
        .image-preview {
            max-width: 400px;
            margin: 15px auto;
            display: none;
            position: relative;
        }

        .image-preview.show {
            display: block;
        }

        .image-preview img {
            width: 100%;
            border-radius: 14px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }

        .remove-img {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(255,255,255,0.95);
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        /* Detected Box */
        .detected-box {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            padding: 14px;
            border-radius: 14px;
            margin-top: 15px;
            margin-bottom: 10px;
            display: none;
            border: 1px solid #a7f3d0;
            animation: fadeIn 0.4s;
        }

        body.dark-mode .detected-box {
            background: linear-gradient(135deg, #064e3b, #065f46);
            border-color: #047857;
        }

        .detected-box.show {
            display: block;
        }

        .detected-title {
            font-weight: 600;
            color: #065f46;
            margin-bottom: 8px;
            font-size: 13px;
        }

        body.dark-mode .detected-title {
            color: #6ee7b7;
        }

        .detected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .detected-tag {
            background: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        body.dark-mode .detected-tag {
            background: var(--card-dark);
            color: #6ee7b7;
            border-color: #047857;
        }

        /* Input Section */
        .input-section {
            margin-bottom: 15px;
        }

        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 13px;
        }

        body.dark-mode .input-section label {
            color: var(--text-dark);
        }

        .char-count {
            font-size: 10px;
            color: #94a3b8;
            text-align: right;
            margin-top: 4px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 14px;
            resize: none;
            background: white;
            color: var(--text-light);
        }

        body.dark-mode textarea {
            background: var(--bg-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Quick Tags */
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .tag {
            background: var(--bg-light);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 12px;
            color: var(--text-light);
            transition: all 0.3s;
        }

        body.dark-mode .tag {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .tag:hover {
            border-color: var(--primary);
        }

        .tag.selected {
            background: var(--primary);
            color: white;
        }

        /* Dietary Section */
        .dietary-section {
            margin: 15px 0;
        }

        .dietary-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dietary-option {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-light);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 12px;
            color: var(--text-light);
            cursor: pointer;
        }

        body.dark-mode .dietary-option {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .dietary-option input {
            accent-color: var(--primary);
            width: 16px;
            height: 16px;
        }

        /* Main Button */
        .main-btn {
            width: 100%;
            padding: 16px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.35);
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .main-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .main-btn:hover::before {
            left: 100%;
        }

        .main-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.45);
        }

        .main-btn:active {
            transform: translateY(-1px);
        }

        .main-btn:disabled {
            background: linear-gradient(135deg, #94a3b8, #64748b);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .main-btn.analyze {
            background: var(--secondary);
            box-shadow: 0 8px 24px rgba(236, 72, 153, 0.35);
        }

        .main-btn.analyze:hover {
            box-shadow: 0 12px 32px rgba(236, 72, 153, 0.45);
        }

        /* Results */
        .results {
            margin-top: 20px;
            display: none;
        }

        .results.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        /* Recipe Card */
        .recipe-card {
            background: var(--bg-light);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 8px 40px rgba(0,0,0,0.12);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        body.dark-mode .recipe-card {
            background: var(--bg-dark);
        }

        .recipe-img-box {
            position: relative;
            height: 200px;
            background: linear-gradient(135deg, #f97316, #dc2626);
            overflow: hidden;
        }

        .recipe-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recipe-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 40px 15px 15px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
        }

        .recipe-name {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .recipe-desc {
            color: rgba(255,255,255,0.9);
            font-size: 13px;
            margin-top: 4px;
        }

        .recipe-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
        }

        .recipe-action {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: rgba(255,255,255,0.95);
            cursor: pointer;
            font-size: 16px;
        }

        .recipe-action.fav {
            background: var(--danger);
            color: white;
        }

        /* Recipe Stats */
        .recipe-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            border-top: 1px solid var(--border-light);
        }

        body.dark-mode .recipe-stats {
            border-color: var(--border-dark);
        }

        .stat-item {
            padding: 12px;
            text-align: center;
            border-right: 1px solid var(--border-light);
        }

        body.dark-mode .stat-item {
            border-color: var(--border-dark);
        }

        .stat-item:last-child {
            border-right: none;
        }

        .stat-icon {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Recipe Body */
        .recipe-body {
            padding: 15px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .section-title {
            color: var(--text-dark);
        }

        .ingredients-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .ing-item {
            padding: 8px 12px;
            background: var(--card-light);
            border-radius: 10px;
            font-size: 13px;
            color: var(--text-light);
            border: 1px solid var(--border-light);
        }

        body.dark-mode .ing-item {
            background: var(--card-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        .steps-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .step-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--card-light);
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }

        body.dark-mode .step-item {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .step-num {
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            flex-shrink: 0;
        }

        .step-text {
            color: var(--text-light);
            font-size: 13px;
            line-height: 1.5;
            padding-top: 3px;
        }

        body.dark-mode .step-text {
            color: var(--text-dark);
        }

        /* Food Card */
        .food-card {
            background: var(--bg-light);
            border-radius: 18px;
            padding: 18px;
            margin-bottom: 15px;
        }

        body.dark-mode .food-card {
            background: var(--bg-dark);
        }

        .food-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .food-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-light);
        }

        body.dark-mode .food-name {
            color: var(--text-dark);
        }

        .food-desc {
            color: #64748b;
            font-size: 13px;
            margin-top: 4px;
        }

        .score-box {
            text-align: center;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .score-circle.good {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .score-circle.moderate {
            background: var(--accent);
        }

        .score-circle.poor {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .score-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Nutrition Grid */
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .nutrition-item {
            background: var(--card-light);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-light);
        }

        body.dark-mode .nutrition-item {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .nutrition-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nutrition-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-light);
        }

        body.dark-mode .nutrition-value {
            color: var(--text-dark);
        }

        .nutrition-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        /* History Section */
        .history-section {
            margin-bottom: 20px;
        }

        .history-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .history-title {
            color: var(--text-dark);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        body.dark-mode .history-item {
            background: var(--bg-dark);
        }

        .history-item:hover {
            transform: translateX(5px);
        }

        .history-img {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .history-info {
            flex: 1;
        }

        .history-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark-mode .history-name {
            color: var(--text-dark);
        }

        .history-date {
            font-size: 11px;
            color: #94a3b8;
        }

        .history-delete {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--card-light);
            cursor: pointer;
            font-size: 14px;
        }

        body.dark-mode .history-delete {
            background: var(--card-dark);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 45px;
            height: 45px;
            border: 4px solid var(--border-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        body.dark-mode .spinner {
            border-color: var(--border-dark);
            border-top-color: var(--primary);
        }

        .loading-text {
            color: var(--text-light);
            font-size: 14px;
        }

        body.dark-mode .loading-text {
            color: var(--text-dark);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--card-dark);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: all 0.4s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Premium Modal */
        .premium-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 8000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .premium-modal.active {
            display: flex;
        }

        .premium-content {
            background: var(--card-light);
            border-radius: 24px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            animation: scaleIn 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        body.dark-mode .premium-content {
            background: var(--card-dark);
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .premium-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .premium-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        body.dark-mode .premium-title {
            color: var(--text-dark);
        }

        .premium-desc {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 25px;
        }

        .premium-features {
            text-align: left;
            margin-bottom: 25px;
        }

        .premium-feature {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 14px;
            color: var(--text-light);
        }

        body.dark-mode .premium-feature {
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .premium-feature:last-child {
            border-bottom: none;
        }

        .premium-check {
            color: var(--success);
            font-size: 18px;
        }

        .premium-plans {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .premium-plan {
            flex: 1;
            padding: 15px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s;
        }

        body.dark-mode .premium-plan {
            border-color: var(--border-dark);
        }

        .premium-plan.selected {
            border-color: var(--primary);
            background: rgba(16,163,127,0.1);
        }

        .plan-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark-mode .plan-name {
            color: var(--text-dark);
        }

        .plan-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .plan-period {
            font-size: 11px;
            color: #64748b;
        }

        .plan-save {
            background: var(--success);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }

        .premium-subscribe {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            color: #78350f;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .premium-close {
            margin-top: 15px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 14px;
            cursor: pointer;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 100vw;
            background: var(--card-light);
            border-top: 1px solid var(--border-light);
            box-shadow: 0 -1px 8px rgba(0,0,0,0.04);
            display: flex;
            justify-content: space-evenly;
            padding: 6px 0;
            padding-bottom: calc(6px + env(safe-area-inset-bottom));
            z-index: 1000;
            overflow: hidden;
        }

        @media (min-width: 640px) {
            .bottom-nav {
                left: 50%;
                transform: translateX(-50%);
                max-width: 640px;
                width: auto;
                right: auto;
            }
        }
        @media (min-width: 768px) {
            .bottom-nav {
                max-width: 720px;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            }
        }

        body.dark-mode .bottom-nav {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 2px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 10px;
            position: relative;
            min-width: 0;
            flex: 1;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 24px;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 4px 4px;
            transition: transform 0.3s;
        }

        .nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }

        .nav-item:hover {
            background: rgba(99, 102, 241, 0.08);
        }

        body.dark-mode .nav-item:hover {
            background: rgba(99, 102, 241, 0.15);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.15);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
            line-height: 1;
        }

        body.dark-mode .nav-label {
            color: var(--text-dark);
        }

        .nav-item.active .nav-label {
            color: var(--primary);
            font-weight: 700;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
        }

        .empty-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        body.dark-mode .empty-icon {
            background: linear-gradient(135deg, #1e1e2e 0%, #252538 100%);
        }

        .empty-icon::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid var(--border-light);
            animation: spin 20s linear infinite;
        }

        .empty-icon i {
            width: 48px;
            height: 48px;
            color: var(--text-muted);
        }

        .empty-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        body.dark-mode .empty-title {
            color: var(--text-dark);
        }

        .empty-desc {
            font-size: 14px;
            color: #94a3b8;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 14px 45px 14px 16px;
            border: 2px solid var(--border-light);
            border-radius: 14px;
            font-size: 15px;
            background: var(--bg-light);
            color: var(--text-light);
            transition: border-color 0.3s;
        }

        body.dark-mode .search-input {
            background: var(--bg-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Meal Plan Styles */
        .meal-plan-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .meal-plan-day {
            background: var(--bg-light);
            border-radius: 16px;
            padding: 15px;
        }

        body.dark-mode .meal-plan-day {
            background: var(--bg-dark);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark-mode .day-header {
            border-color: var(--border-dark);
        }

        .day-header h4 {
            margin: 0;
            font-size: 16px;
            color: var(--text-light);
        }

        body.dark-mode .day-header h4 {
            color: var(--text-dark);
        }

        .day-date {
            font-size: 12px;
            color: #64748b;
        }

        .meal-slots {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .meal-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--card-light);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        body.dark-mode .meal-slot {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .meal-slot.filled {
            border-style: solid;
            border-color: var(--primary);
        }

        .meal-slot:hover {
            transform: translateX(5px);
        }

        .meal-icon {
            font-size: 24px;
        }

        .meal-content {
            flex: 1;
        }

        .meal-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark-mode .meal-name {
            color: var(--text-dark);
        }

        .meal-calories {
            font-size: 12px;
            color: #64748b;
        }

        .meal-empty {
            font-size: 13px;
            color: #94a3b8;
        }

        .meal-remove {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: none;
            background: var(--danger);
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        /* Recipe Selector */
        .recipe-selector-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .recipe-selector-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        body.dark-mode .recipe-selector-item {
            background: var(--bg-dark);
        }

        .recipe-selector-item:hover {
            transform: translateX(5px);
            background: var(--primary);
            color: white;
        }

        .recipe-thumb {
            font-size: 32px;
        }

        .recipe-info {
            flex: 1;
        }

        .recipe-meta {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }

        /* Shopping List Styles */
        .shopping-list {
            background: var(--bg-light);
            border-radius: 16px;
            padding: 15px;
        }

        body.dark-mode .shopping-list {
            background: var(--bg-dark);
        }

        .shopping-category {
            margin-bottom: 15px;
        }

        .shopping-category-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .shopping-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--card-light);
            border-radius: 10px;
            margin-bottom: 6px;
        }

        body.dark-mode .shopping-item {
            background: var(--card-dark);
        }

        .shopping-item.checked {
            opacity: 0.5;
        }

        .shopping-item.checked .shopping-item-name {
            text-decoration: line-through;
        }

        .shopping-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .shopping-item-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-light);
        }

        body.dark-mode .shopping-item-name {
            color: var(--text-dark);
        }

        .shopping-item-qty {
            font-size: 12px;
            color: #64748b;
            background: var(--bg-light);
            padding: 4px 8px;
            border-radius: 8px;
        }

        body.dark-mode .shopping-item-qty {
            background: var(--bg-dark);
        }

        /* Settings Item */
        .settings-item {
            padding: 15px;
            background: var(--bg-light);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        body.dark-mode .settings-item {
            background: var(--bg-dark);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 15px 15px 100px;
            }

            h1 {
                font-size: 20px;
            }

            .nutrition-grid, .recipe-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .ingredients-grid {
                grid-template-columns: 1fr;
            }

            .upload-btns {
                flex-direction: column;
            }

            .upload-btn {
                width: 100%;
                justify-content: center;
            }

            .premium-plans {
                flex-direction: column;
            }

            .credits-display {
                padding: 4px 10px;
                font-size: 12px;
            }
        }


        /* ===== CAMERA SYSTEM ===== */
        /* ===== NATIVE CAMERA EXPERIENCE ===== */
        .camera-preview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: #000;
            z-index: 10000;
            overflow: hidden;
        }
        .camera-preview.active {
            display: block;
        }
        .camera-preview video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Top bar */
        .camera-top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: calc(60px + env(safe-area-inset-top));
            padding-top: env(safe-area-inset-top);
            background: linear-gradient(rgba(0,0,0,0.5), transparent);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 16px;
            padding-right: 16px;
            z-index: 10;
        }
        .cam-top-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-appearance: none;
        }
        .cam-top-btn:active { opacity: 0.7; }
        .camera-mode-label {
            color: white;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        /* Bottom area */
        .camera-bottom-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            background: linear-gradient(transparent, rgba(0,0,0,0.6) 30%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }
        .camera-guide-text {
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            text-shadow: 0 1px 4px rgba(0,0,0,0.5);
        }
        .camera-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            width: 100%;
            padding: 0 40px;
        }
        .cam-side-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-appearance: none;
        }
        .cam-side-btn:active { opacity: 0.7; }
        .capture-btn {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            border: 4px solid white;
            background: transparent;
            cursor: pointer;
            z-index: 10;
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            flex-shrink: 0;
        }
        .capture-btn::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            border-radius: 50%;
            background: white;
            transition: all 0.1s;
        }
        .capture-btn:active::after {
            background: #e5e5e5;
            top: 6px; left: 6px; right: 6px; bottom: 6px;
        }


        /* ===== FLOATING GENERATE BUTTON ===== */
        .floating-generate {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 16px 20px;
            background: linear-gradient(transparent 0%, #FAFAF7 25%);
            z-index: 50;
            margin: 0 -16px;
            margin-top: 15px;
        }
        body.dark-mode .floating-generate {
            background: linear-gradient(transparent 0%, #1C1C22 25%);
        }

        /* ===== ALLERGY & FRIDGE MODE ===== */
        .allergy-option span {
            color: #dc2626;
        }
        body.dark-mode .allergy-option span {
            color: #fca5a5;
        }
        .fridge-mode-section {
            margin: 12px 0 15px;
        }
        .fridge-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: #EEF0FF;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            flex-wrap: wrap;
        }
        .fridge-toggle:has(input:checked) {
            border-color: var(--primary);
            background: #E8EAFF;
        }
        body.dark-mode .fridge-toggle {
            background: #2A2A32;
        }
        body.dark-mode .fridge-toggle:has(input:checked) {
            border-color: var(--primary-light);
        }
        .fridge-toggle input {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }
        .fridge-toggle-label {
            font-weight: 700;
            font-size: 14px;
            color: var(--text-light);
        }
        body.dark-mode .fridge-toggle-label { color: var(--text-dark); }
        .fridge-toggle-desc {
            font-size: 12px;
            color: var(--text-muted);
            width: 100%;
            padding-left: 30px;
            margin-top: -4px;
        }

        /* ===== VOICE COOKING ASSISTANT ===== */
        .voice-cook-panel {
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            border-radius: 18px;
            padding: 20px;
            margin-top: 15px;
            color: white;
        }
        .voice-cook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .voice-cook-title {
            font-size: 16px;
            font-weight: 700;
        }
        .voice-cook-close {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }
        .voice-step-display {
            text-align: center;
            padding: 20px 10px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .voice-step-num {
            font-size: 14px;
            color: #a5b4fc;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .voice-step-text {
            font-size: 18px;
            line-height: 1.6;
            font-weight: 500;
        }
        .voice-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
        }
        .voice-ctrl-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .voice-ctrl-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .voice-ctrl-btn.small { width: 44px; height: 44px; font-size: 18px; }
        .voice-ctrl-btn.big { width: 64px; height: 64px; font-size: 28px; background: var(--primary); }
        .voice-ctrl-btn.big:hover { background: var(--primary-dark); }
        .voice-progress {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
        }
        .voice-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transition: all 0.2s;
        }
        .voice-dot.active {
            background: #818cf8;
            transform: scale(1.3);
        }
        .voice-dot.done {
            background: #22c55e;
        }

        /* ===== SHOPPING LIST ===== */
        .shopping-list-panel {
            background: var(--bg-light);
            border-radius: 18px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid var(--border-light);
        }
        body.dark-mode .shopping-list-panel {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }
        .shopping-list-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 12px;
        }
        body.dark-mode .shopping-list-title { color: var(--text-dark); }
        .shopping-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
        }
        body.dark-mode .shopping-item { border-color: var(--border-dark); }
        .shopping-item:last-child { border: none; }
        .shopping-check {
            width: 22px;
            height: 22px;
            accent-color: #22c55e;
            cursor: pointer;
        }
        .shopping-item.checked .shopping-text {
            text-decoration: line-through;
            opacity: 0.5;
        }
        .shopping-text {
            flex: 1;
            font-size: 14px;
            color: var(--text-light);
        }
        body.dark-mode .shopping-text { color: var(--text-dark); }
        .shopping-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .shopping-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        canvas {
            display: none;
        }

        .servings-control {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: center;
            margin-top: 6px;
        }
        .serv-btn {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 2px solid var(--primary);
            background: var(--bg-light);
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            color: var(--primary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .serv-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }
        .serv-btn:active {
            transform: scale(0.95);
        }
        body.dark-mode .serv-btn {
            background: var(--bg-dark);
            color: var(--primary-light);
            border-color: var(--primary-light);
        }
        body.dark-mode .serv-btn:hover {
            background: var(--primary);
            color: white;
        }
        #servingsValue {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            min-width: 24px;
            text-align: center;
        }
    
        /* Recipe Images */
        .recipe-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            transition: transform 0.4s ease;
        }
        .recipe-img-box:hover img {
            transform: scale(1.05);
        }

        /* API Hint Banner */
        .api-hint-banner {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 1.5px solid #93c5fd;
            border-radius: 14px;
            padding: 12px 14px;
            margin-bottom: 14px;
            cursor: pointer;
        }
        body.dark-mode .api-hint-banner {
            background: linear-gradient(135deg, #1e3a5f, #1e40af22);
            border-color: #3b82f6;
        }
        body.dark-mode .api-hint-banner div[style*="color: #1e40af"] {
            color: #93c5fd !important;
        }
        body.dark-mode .api-hint-banner div[style*="color: #3b82f6"] {
            color: #60a5fa !important;
        }

        /* ===== API Setup Guide Modal ===== */
        .api-guide-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 8500;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
            backdrop-filter: blur(4px);
        }
        .api-guide-modal.active { display: flex; }
        .api-guide-content {
            background: var(--card-light);
            border-radius: 24px 24px 0 0;
            padding: 24px 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            max-width: 100%;
            width: 100%;
            animation: slideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @media (min-width: 640px) {
            .api-guide-modal {
                align-items: center;
                padding: 20px;
            }
            .api-guide-content {
                max-width: 420px;
                border-radius: 24px;
                padding: 28px;
            }
        }
        body.dark-mode .api-guide-content {
            background: var(--card-dark);
        }
        .api-guide-steps {
            margin: 12px 0;
        }
        .api-guide-step {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
            align-items: center;
        }
        body.dark-mode .api-guide-step {
            border-color: var(--border-dark);
        }
        .api-guide-step:last-child { border-bottom: none; }
        .api-guide-num {
            width: 26px; height: 26px;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 12px;
            flex-shrink: 0;
        }
        .api-guide-text {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.4;
        }
        body.dark-mode .api-guide-text { color: var(--text-dark); }
        .api-guide-text a {
            color: var(--primary);
            text-decoration: underline;
        }

        /* ===== Better Error Box ===== */
        .error-box {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: 1px solid #fecaca;
            border-radius: 14px;
            padding: 18px;
            text-align: center;
        }
        body.dark-mode .error-box {
            background: linear-gradient(135deg, #450a0a, #7f1d1d);
            border-color: #991b1b;
        }
        .error-box .error-icon { font-size: 36px; margin-bottom: 8px; }
        .error-box .error-title {
            font-size: 16px; font-weight: 700;
            color: #991b1b; margin-bottom: 6px;
        }
        body.dark-mode .error-box .error-title { color: #fca5a5; }
        .error-box .error-desc {
            font-size: 13px; color: #b91c1c; line-height: 1.5;
        }
        body.dark-mode .error-box .error-desc { color: #fca5a5; }
        .error-box .error-action {
            margin-top: 12px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        }

        /* ===== Progressive Loading ===== */
        .loading-progress {
            text-align: center;
            padding: 40px 20px;
        }
        .loading-progress .spinner {
            width: 50px; height: 50px;
            border: 4px solid var(--border-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        body.dark-mode .loading-progress .spinner {
            border-color: var(--border-dark);
            border-top-color: var(--primary);
        }
        .loading-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 260px;
            margin: 0 auto;
        }
        .loading-step {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-muted);
            transition: all 0.4s;
        }
        .loading-step.active {
            color: var(--primary);
            font-weight: 600;
        }
        .loading-step.done {
            color: var(--success);
        }
        .loading-step-icon {
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            background: var(--bg-light);
            transition: all 0.4s;
            flex-shrink: 0;
        }
        body.dark-mode .loading-step-icon { background: var(--bg-dark); }
        .loading-step.active .loading-step-icon {
            background: var(--primary);
            color: white;
            animation: pulse 1s infinite;
        }
        .loading-step.done .loading-step-icon {
            background: var(--success);
            color: white;
        }

        /* ===== Better Empty States ===== */
        .empty-state-action {
            margin-top: 16px;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .empty-state-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
        }

        /* ===== Success Animation ===== */
        .success-pulse {
            animation: successPulse 0.6s ease;
        }
        @keyframes successPulse {
            0% { transform: scale(1); }
            30% { transform: scale(1.08); }
            60% { transform: scale(0.97); }
            100% { transform: scale(1); }
        }

        /* ===== Confetti ===== */
        .confetti-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        .confetti-piece {
            position: absolute;
            width: 10px; height: 10px;
            top: -10px;
            animation: confettiFall 2.5s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        /* ===== Accessibility Focus ===== */
        *:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            border-radius: 4px;
        }
        .sr-only {
            position: absolute;
            width: 1px; height: 1px;
            padding: 0; margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* ===== Cook Specific Dish - Enhanced ===== */

        /* ===== NOTIFICATION SYSTEM ===== */
        .notif-center {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 18px;
            border: 1px solid var(--border-light);
        }
        body.dark-mode .notif-center {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }
        .notif-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }
        .notif-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-mode .notif-title { color: var(--text-dark); }
        .notif-badge {
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
        }
        .notif-toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        body.dark-mode .notif-toggle-row { border-color: var(--border-dark); }
        .notif-toggle-row:last-child { border-bottom: none; }
        .notif-toggle-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .notif-toggle-icon {
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        .notif-toggle-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
        }
        body.dark-mode .notif-toggle-text { color: var(--text-dark); }
        .notif-toggle-desc {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
        }
        .notif-switch {
            position: relative;
            width: 48px;
            height: 26px;
            flex-shrink: 0;
        }
        .notif-switch input { opacity: 0; width: 0; height: 0; }
        .notif-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #cbd5e1;
            border-radius: 26px;
            transition: 0.3s;
        }
        .notif-slider::before {
            content: '';
            position: absolute;
            height: 20px; width: 20px;
            left: 3px; bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .notif-switch input:checked + .notif-slider { background: var(--accent); }
        .notif-switch input:checked + .notif-slider::before { transform: translateX(22px); }
        body.dark-mode .notif-slider { background: #475569; }

        .notif-time-picker {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        .notif-time-btn {
            padding: 5px 10px;
            border: 1.5px solid var(--border-light);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-light);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        body.dark-mode .notif-time-btn { background: var(--bg-dark); border-color: var(--border-dark); color: var(--text-dark); }
        .notif-time-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .notif-time-btn:hover { border-color: var(--primary); }

        .notif-permission-banner {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #fcd34d;
            border-radius: 14px;
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        body.dark-mode .notif-permission-banner {
            background: linear-gradient(135deg, #78350f, #92400e);
            border-color: #b45309;
        }
        .notif-permission-btn {
            margin-top: 10px;
            padding: 10px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
        }

        /* In-App Notification Popup */
        .in-app-notif {
            position: fixed;
            top: -120px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 16px;
            padding: 14px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9500;
            max-width: 360px;
            width: calc(100% - 40px);
            transition: top 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(0,0,0,0.06);
        }
        body.dark-mode .in-app-notif {
            background: var(--card-dark);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border-color: var(--border-dark);
        }
        .in-app-notif.show { top: 20px; }
        .in-app-notif-icon { font-size: 28px; flex-shrink: 0; }
        .in-app-notif-body { flex: 1; }
        .in-app-notif-title {
            font-size: 14px; font-weight: 700;
            color: var(--text-light);
        }
        body.dark-mode .in-app-notif-title { color: var(--text-dark); }
        .in-app-notif-msg { font-size: 12px; color: #64748b; margin-top: 2px; }
        .in-app-notif-close {
            background: none; border: none;
            font-size: 18px; cursor: pointer; color: #94a3b8; padding: 4px;
        }
        .in-app-notif-action {
            margin-top: 6px;
            padding: 5px 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ===== HEALTH TARGET SYSTEM ===== */
        .health-dashboard {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 50%, #a7f3d0 100%);
            border-radius: 24px;
            padding: 22px;
            margin-bottom: 20px;
            border: 1px solid #6ee7b7;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.12);
        }
        body.dark-mode .health-dashboard {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border-color: #047857;
        }
        .health-dashboard::before {
            content: '';
            position: absolute;
            top: -40px; right: -40px;
            width: 120px; height: 120px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 50%;
        }
        .health-dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .health-dash-title {
            font-size: 16px;
            font-weight: 700;
            color: #065f46;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-mode .health-dash-title { color: #6ee7b7; }
        .health-edit-btn {
            padding: 6px 14px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid #6ee7b7;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #065f46;
            cursor: pointer;
            transition: all 0.3s;
        }
        body.dark-mode .health-edit-btn { color: #6ee7b7; border-color: #047857; }
        .health-edit-btn:hover { background: rgba(16, 185, 129, 0.3); transform: scale(1.05); }

        .health-goal-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 14px;
        }
        .health-goal-badge.loss { background: #fef3c7; color: #92400e; }
        .health-goal-badge.maintain { background: #dbeafe; color: var(--primary); }
        .health-goal-badge.gain { background: #ede9fe; color: #5b21b6; }
        .health-goal-badge.healthy { background: #d1fae5; color: #065f46; }

        .health-progress-ring {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .ring-item {
            text-align: center;
            position: relative;
        }
        .ring-svg {
            width: 80px;
            height: 80px;
            transform: rotate(-90deg);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .ring-bg {
            fill: none;
            stroke: rgba(0,0,0,0.08);
            stroke-width: 6;
        }
        body.dark-mode .ring-bg { stroke: rgba(255,255,255,0.1); }
        .ring-fill {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease;
        }
        .ring-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -55%);
            font-size: 14px;
            font-weight: 700;
            color: var(--text-light);
        }
        body.dark-mode .ring-value { color: var(--text-dark); }
        .ring-label {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
            font-weight: 600;
        }

        .health-daily-score {
            display: flex;
            align-items: center;
            gap: 14px;
            background: white;
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 14px;
        }
        body.dark-mode .health-daily-score {
            background: rgba(0,0,0,0.2);
        }
        .daily-score-circle {
            width: 56px; height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 800;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        .daily-score-circle:hover {
            transform: scale(1.1);
        }
        .daily-score-info { flex: 1; }
        .daily-score-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-light);
        }
        body.dark-mode .daily-score-title { color: var(--text-dark); }
        .daily-score-desc {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }
        .daily-score-streak {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 700;
            color: #f59e0b;
        }

        .health-water-section {
            background: white;
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 14px;
        }
        body.dark-mode .health-water-section { background: rgba(0,0,0,0.2); }
        .water-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .water-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
        }
        body.dark-mode .water-title { color: var(--text-dark); }
        .water-count {
            font-size: 13px;
            color: #3b82f6;
            font-weight: 700;
        }
        .water-glasses {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .water-glass {
            width: 38px; height: 38px;
            border-radius: 12px;
            border: 2px solid #93c5fd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }
        body.dark-mode .water-glass {
            background: transparent;
            border-color: #1d4ed8;
        }
        .water-glass.filled {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        .water-glass:hover { transform: scale(1.15); }

        .health-tips {
            background: white;
            padding: 14px;
            border-radius: 14px;
        }
        body.dark-mode .health-tips { background: rgba(0,0,0,0.2); }
        .health-tip {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.4;
        }
        body.dark-mode .health-tip { border-color: var(--border-dark); color: var(--text-dark); }
        .health-tip:last-child { border-bottom: none; }
        .tip-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

        /* Health Profile Modal */
        .profile-field {
            margin-bottom: 16px;
            text-align: left;
        }
        .profile-field label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        body.dark-mode .profile-field label { color: var(--text-dark); }
        .profile-select, .profile-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 14px;
            background: var(--bg-light);
            color: var(--text-light);
            transition: border-color 0.3s;
            -webkit-appearance: none;
        }
        body.dark-mode .profile-select, body.dark-mode .profile-input {
            background: var(--bg-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
        .profile-select:focus, .profile-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .goal-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .goal-option {
            padding: 14px 10px;
            border: 2px solid var(--border-light);
            border-radius: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-light);
        }
        body.dark-mode .goal-option {
            background: var(--bg-dark);
            border-color: var(--border-dark);
        }
        .goal-option:hover { border-color: var(--accent); }
        .goal-option.selected {
            border-color: var(--accent);
            background: rgba(20, 184, 166, 0.1);
        }
        .goal-option-icon { font-size: 28px; margin-bottom: 6px; }
        .goal-option-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
        }
        body.dark-mode .goal-option-name { color: var(--text-dark); }
        .goal-option-desc {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
        }
        .diet-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .diet-chip {
            padding: 8px 14px;
            border: 2px solid var(--border-light);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-light);
            background: var(--bg-light);
        }
        body.dark-mode .diet-chip {
            background: var(--bg-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
        .diet-chip:hover { border-color: var(--accent); }
        .diet-chip.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .health-no-profile {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border-radius: 20px;
            margin-bottom: 20px;
            border: 1px solid #C6E7D4;
        }
        body.dark-mode .health-no-profile {
            background: linear-gradient(135deg, #064e3b, #065f46);
            border-color: #047857;
        }
        .health-no-profile-icon { font-size: 48px; margin-bottom: 12px; }
        .health-no-profile-title {
            font-size: 18px; font-weight: 700;
            color: #065f46; margin-bottom: 6px;
        }
        body.dark-mode .health-no-profile-title { color: #6ee7b7; }
        .health-no-profile-desc {
            font-size: 13px; color: #64748b; margin-bottom: 16px;
        }
        .health-setup-btn {
            padding: 14px 28px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(20, 184, 166, 0.3);
            transition: all 0.3s;
        }
        .health-setup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(20, 184, 166, 0.4);
        }

        /* ===== Cook Specific Dish - Enhanced ===== */
        .cook-specific-section {
            margin: 0 0 18px 0;
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            padding: 18px;
            border-radius: 16px;
            border: 2px solid #c4b5fd;
            position: relative;
            overflow: hidden;
        }
        body.dark-mode .cook-specific-section {
            background: linear-gradient(135deg, #2e1065, #3b0764);
            border-color: #7c3aed;
        }
        .cook-specific-section::before {
            content: '';
            position: absolute;
            top: -30px; right: -30px;
            width: 80px; height: 80px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 50%;
        }
        .cook-specific-label {
            color: #5b21b6;
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-mode .cook-specific-label { color: #c4b5fd; }
        .cook-specific-row {
            display: flex;
            gap: 10px;
        }
        .cook-specific-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #c4b5fd;
            border-radius: 12px;
            font-size: 15px;
            background: white;
            color: var(--text-light);
            transition: border-color 0.3s;
        }
        body.dark-mode .cook-specific-input {
            background: rgba(0,0,0,0.3);
            border-color: #7c3aed;
            color: var(--text-dark);
        }
        .cook-specific-input:focus {
            outline: none;
            border-color: #7c3aed;
        }
        .cook-specific-btn {
            padding: 14px 22px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            box-shadow: 0 4px 14px rgba(124, 58, 237, 0.3);
        }
        .cook-specific-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
        }

        .history-img {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea, #764ba2);
            flex-shrink: 0;
        }
        .meal-thumb {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .recipe-selector-thumb {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/>
                <line x1="6" y1="17" x2="18" y2="17"/>
            </svg>
        </div>
        <div class="splash-title">SnapChef</div>
        <div class="splash-subtitle">AI-Powered Recipe Generator</div>
        <div class="splash-loader"></div>
    </div>

    <!-- Onboarding -->
    <div class="onboarding" id="onboarding">
        <div class="onboarding-slides">
            <div class="onboarding-slide active" data-slide="0">
                <div class="onboarding-icon"></div>
                <h2 class="onboarding-title" data-i18n="onboard1Title">Scan Ingredients</h2>
                <p class="onboarding-desc" data-i18n="onboard1Desc">Take a photo of your ingredients and let AI detect them automatically</p>
            </div>
            <div class="onboarding-slide" data-slide="1">
                <div class="onboarding-icon"></div>
                <h2 class="onboarding-title" data-i18n="onboard2Title">Generate Recipes</h2>
                <p class="onboarding-desc" data-i18n="onboard2Desc">Get personalized recipes based on what you have in your kitchen</p>
            </div>
            <div class="onboarding-slide" data-slide="2">
                <div class="onboarding-icon"></div>
                <h2 class="onboarding-title" data-i18n="onboard3Title">Analyze Nutrition</h2>
                <p class="onboarding-desc" data-i18n="onboard3Desc">Get detailed nutrition info and healthier alternatives for any meal</p>
            </div>
        </div>
        <div class="onboarding-dots">
            <div class="onboarding-dot active" data-dot="0"></div>
            <div class="onboarding-dot" data-dot="1"></div>
            <div class="onboarding-dot" data-dot="2"></div>
        </div>
        <div class="onboarding-btns">
            <button class="onboarding-btn skip" onclick="skipOnboarding()" data-i18n="skip">Skip</button>
            <button class="onboarding-btn next" onclick="nextSlide()" data-i18n="next">Next</button>
        </div>
    </div>

    <!-- Premium Modal -->
    <div class="premium-modal" id="premiumModal">
        <div class="premium-content">
            <div class="premium-icon"></div>
            <h2 class="premium-title" data-i18n="goPremium">Go Premium</h2>
            <p class="premium-desc" data-i18n="premiumDesc">Unlock unlimited recipes and exclusive features</p>
            <div class="premium-features">
                <div class="premium-feature"><span class="premium-check"></span><span data-i18n="premiumF1">Unlimited recipe generations</span></div>
                <div class="premium-feature"><span class="premium-check"></span><span data-i18n="premiumF2">No ads experience</span></div>
                <div class="premium-feature"><span class="premium-check"></span><span data-i18n="premiumF3">Priority AI processing</span></div>
                <div class="premium-feature"><span class="premium-check"></span><span data-i18n="premiumF4">Offline saved recipes</span></div>
                <div class="premium-feature"><span class="premium-check"></span><span data-i18n="premiumF5">Meal Planning</span></div>
            </div>
            <div class="premium-plans">
                <div class="premium-plan selected" data-plan="monthly" onclick="selectPlan('monthly')">
                    <div class="plan-name" data-i18n="monthly">Monthly</div>
                    <div class="plan-price">$4.99</div>
                    <div class="plan-period" data-i18n="perMonth">/month</div>
                </div>
                <div class="premium-plan" data-plan="yearly" onclick="selectPlan('yearly')">
                    <div class="plan-name" data-i18n="yearly">Yearly</div>
                    <div class="plan-price">$29.99</div>
                    <div class="plan-period" data-i18n="perYear">/year</div>
                    <div class="plan-save" data-i18n="save50">Save 50%</div>
                </div>
            </div>
            <button class="premium-subscribe" onclick="subscribePremium()" data-i18n="subscribe">Subscribe Now</button>
            <button class="premium-close" onclick="closePremiumModal()" data-i18n="maybeLater">Maybe Later</button>
        </div>
    </div>

    <!-- Buy Credits Modal -->
    <div class="premium-modal" id="buyCreditsModal">
        <div class="premium-content">
            <div class="premium-icon"></div>
            <h2 class="premium-title" data-i18n="buyCredits">Buy Credits</h2>
            <p class="premium-desc">Choose a package that suits your needs</p>
            <div class="premium-plans" style="flex-direction: column;">
                <div class="premium-plan" onclick="CreditSystem.buyPackage('small')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="plan-name">Small Pack</div>
                            <div class="plan-period">50 credits</div>
                        </div>
                        <div class="plan-price">$2.99</div>
                    </div>
                </div>
                <div class="premium-plan selected" onclick="CreditSystem.buyPackage('medium')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="plan-name">Medium Pack</div>
                            <div class="plan-period">150 credits</div>
                        </div>
                        <div class="plan-price">$6.99</div>
                    </div>
                    <div class="plan-save">Best Value</div>
                </div>
                <div class="premium-plan" onclick="CreditSystem.buyPackage('large')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="plan-name">Large Pack</div>
                            <div class="plan-period">500 credits</div>
                        </div>
                        <div class="plan-price">$19.99</div>
                    </div>
                    <div class="plan-save">Save 40%</div>
                </div>
            </div>
            <button class="premium-close" onclick="document.getElementById('buyCreditsModal').classList.remove('active')">Cancel</button>
        </div>
    </div>

    <!-- Import Recipe Modal -->
    <div class="premium-modal" id="importModal">
        <div class="premium-content">
            <div class="premium-icon"></div>
            <h2 class="premium-title" data-i18n="importRecipe">Import Recipe</h2>
            <p class="premium-desc">Paste a recipe URL from Instagram, YouTube, TikTok or any recipe website</p>
            <input type="url" id="importURL" class="api-input" placeholder="https://instagram.com/p/..." style="margin-top: 15px;">
            <button class="main-btn" onclick="importRecipeFromURL()" style="margin-top: 15px;">
                <span></span>
                <span data-i18n="importFromURL">Import Recipe</span>
            </button>
            <button class="premium-close" onclick="RecipeImporter.closeImportModal()">Cancel</button>
        </div>
    </div>

    <!-- Meal Selector Modal -->
    <div class="premium-modal" id="mealSelectorModal">
        <div class="premium-content">
            <h3 class="premium-title">Select Recipe</h3>
            <div id="recipeSelectorList" class="recipe-selector-list"></div>
            <button class="main-btn" onclick="switchTab('recipe')" style="margin-top: 15px; background: var(--secondary);">
                <span></span>
                <span>Create New Recipe</span>
            </button>
            <button class="premium-close" onclick="document.getElementById('mealSelectorModal').classList.remove('active')">Close</button>
        </div>
    </div>

    <!-- Shopping List Modal -->
    <div class="premium-modal" id="shoppingModal">
        <div class="premium-content" style="max-height: 80vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 class="premium-title" style="margin: 0;"> Shopping List</h3>
                <button class="icon-btn" onclick="ShoppingList.clearAll()"></button>
            </div>
            <div id="shoppingListContainer"></div>
            <button class="main-btn" onclick="ShoppingList.share()" style="margin-top: 15px;">
                <span></span>
                <span>Share List</span>
            </button>
            <button class="premium-close" onclick="document.getElementById('shoppingModal').classList.remove('active')">Close</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- API Setup Guide Modal -->
    <!-- API Guide Modal removed - API key now managed by backend -->

    <!-- Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <!-- Login Screen -->
    <div id="loginScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #F5F4F0; z-index: 8000; flex-direction: column; align-items: center; justify-content: center; padding: 24px;">
        <div style="background: white; border-radius: 24px; padding: 32px 24px; max-width: 380px; width: 100%; box-shadow: 0 12px 40px rgba(0,0,0,0.1);">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 48px; margin-bottom: 8px;"></div>
                <h1 style="font-size: 28px; font-weight: 800; color: #1e293b; margin-bottom: 4px;">SnapChef</h1>
                <p style="color: #64748b; font-size: 14px;">AI-Powered Recipe Generator</p>
            </div>
            
            <!-- Google Sign In -->
            <button onclick="signInWithGoogle()" style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 16px; transition: all 0.2s;">
                <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                Continue with Google
            </button>
            
            <!-- Divider -->
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                <span style="color: #94a3b8; font-size: 12px;">or</span>
                <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
            </div>
            
            <!-- Email Sign In -->
            <input type="email" id="loginEmail" placeholder="Email" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 14px; margin-bottom: 10px; outline: none; box-sizing: border-box;">
            <input type="password" id="loginPassword" placeholder="Password" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 14px; margin-bottom: 16px; outline: none; box-sizing: border-box;">
            <button onclick="signInWithEmail()" style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer;">
                Sign In / Sign Up
            </button>
            
            <p style="text-align: center; margin-top: 16px; font-size: 12px; color: #94a3b8;">
                 First 10 recipes are free!
            </p>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="appContainer" style="display: none;">
        <div class="container">
            <!-- Subscription Banner -->
            <div class="subscription-banner" id="subBanner" onclick="openPremiumModal()">
                <span class="sub-icon"></span>
                <div class="sub-text">
                    <div class="sub-title" data-i18n="upgradePremium">Upgrade to Premium</div>
                    <div class="sub-desc">Unlimited recipes  Ad-free  Meal planning</div>
                </div>
                <button class="sub-btn" data-i18n="upgrade">Upgrade</button>
            </div>

            <!-- Usage Counter -->
            <div class="usage-counter" id="usageCounter">
                <span class="usage-text"><span id="usageCount">0</span>/5 <span data-i18n="recipesToday">recipes today</span> <span style="color:var(--text-muted);font-size:11px;">(or use credits)</span></span>
                <div class="usage-bar"><div class="usage-fill" id="usageFill"></div></div>
            </div>

            <!-- Header -->
            <header class="header">
                <div class="logo">
                    <span class="logo-icon"><i data-lucide="chef-hat"></i></span>
                    <h1>SnapChef</h1>
                    <span class="premium-badge hidden" id="premiumBadge">PRO</span>
                </div>
                <div class="header-btns">
                    <div class="credits-display" onclick="CreditSystem.showBuyModal()">
                        <i data-lucide="gem" style="width:16px;height:16px;"></i>
                        <span id="creditsDisplay">10</span>
                    </div>
                    <div class="lang-selector">
                        <button class="icon-btn lang-btn" onclick="toggleLangDropdown()" id="langBtn"><i data-lucide="globe"></i></button>
                        <div class="lang-dropdown" id="langDropdown">
                            <div class="lang-option active" data-lang="en" onclick="setLanguage('en')"> English</div>
                            <div class="lang-option" data-lang="az" onclick="setLanguage('az')"> Azrbaycan</div>
                            <div class="lang-option" data-lang="ru" onclick="setLanguage('ru')"> </div>
                        </div>
                    </div>
                    <button class="icon-btn" onclick="toggleVoice()" id="voiceBtn" title="Voice Input"><i data-lucide="mic"></i></button>
                    <button class="icon-btn" onclick="toggleDarkMode()" id="darkBtn"><i data-lucide="moon"></i></button>
                </div>
            </header>

            <!-- Voice Indicator -->
            <div class="voice-indicator" id="voiceIndicator">
                <div class="voice-indicator-dot"></div>
                <span class="voice-indicator-text" data-i18n="listening"> Listening... say your ingredients</span>
            </div>

            <!-- Offline Indicator -->
            <div class="offline-indicator" id="offlineIndicator">
                <span></span>
                <span data-i18n="offline">You are offline. Some features may not work.</span>
            </div>

            <!-- Recipe Tab -->
            <div class="tab-content active" id="recipeTab">
                <!-- History Section -->
                <!-- Usage Counter -->
                <div id="usageCounterBanner" class="api-hint-banner" style="display:block; background: #EEF0FF; cursor: default;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 22px;"></div>
                        <div style="flex:1;">
                            <div style="font-weight: 700; font-size: 13px; color: var(--primary);" id="usageCounter">Loading...</div>
                            <div style="font-size: 11px; color: var(--primary); margin-top: 2px;">Upgrade to Premium for unlimited</div>
                        </div>
                    </div>
                </div>

                <div class="history-section" id="historySection" style="display: none;">
                    <h3 class="history-title"> <span data-i18n="recentRecipes">Recent Recipes</span></h3>
                    <div class="history-list" id="historyList"></div>
                </div>

                <!-- Upload Section -->
                <div class="upload-section" role="region" aria-label="Upload ingredients">
                    <span class="upload-icon"></span>
                    <h3 class="upload-title" data-i18n="scanIngredients">Scan Your Ingredients</h3>
                    <p class="upload-subtitle" data-i18n="takePhoto">Take a photo or upload an image</p>
                    <div class="upload-btns">
                        <button class="upload-btn primary" onclick="startCamera('recipe')" aria-label="Open camera to scan ingredients">
                            <span></span>
                            <span data-i18n="camera">Camera</span>
                        </button>
                        <button class="upload-btn secondary" onclick="triggerUpload('recipe')" aria-label="Upload image of ingredients">
                            <span></span>
                            <span data-i18n="upload">Upload</span>
                        </button>
                        <button class="upload-btn tertiary" onclick="RecipeImporter.openImportModal()" aria-label="Import recipe from URL">
                            <span></span>
                            <span data-i18n="importRecipe">Import URL</span>
                        </button>
                    </div>
                    <input type="file" id="recipeFileInput" class="file-input" accept="image/*" onchange="handleUpload(event, 'recipe')">
                </div>

                <!-- Camera Preview -->
                <div class="camera-preview" id="recipeCameraPreview">
                    <video id="recipeVideo" autoplay playsinline muted></video>
                    <div class="camera-top-bar">
                        <button class="cam-top-btn" onclick="closeCamera('recipe')"></button>
                        <span class="camera-mode-label">INGREDIENTS</span>
                        <button class="cam-top-btn" onclick="switchCamera('recipe')"></button>
                    </div>
                    <div class="camera-bottom-area">
                        <div class="camera-guide-text">Point at your ingredients</div>
                        <div class="camera-controls">
                            <button class="cam-side-btn" onclick="triggerUpload('recipe')"></button>
                            <button class="capture-btn" onclick="capturePhoto('recipe')"></button>
                            <button class="cam-side-btn" onclick="closeCamera('recipe')"></button>
                        </div>
                    </div>
                </div>

                <!-- Image Preview -->
                <div class="image-preview" id="recipeImagePreview">
                    <img id="recipeImage" alt="Uploaded ingredients">
                    <button class="remove-img" onclick="removeImage('recipe')"></button>
                </div>

                <!-- Detected Ingredients -->
                <div class="detected-box" id="recipeDetected">
                    <div class="detected-title"> <span data-i18n="detectedIngredients">Detected Ingredients</span></div>
                    <div class="detected-tags" id="recipeDetectedTags"></div>
                </div>

                <!-- Input Section -->
                <div class="input-section">
                    <label for="ingredients"> <span data-i18n="yourIngredients">Your Ingredients</span></label>
                    <textarea id="ingredients" rows="3" placeholder="e.g., eggs, tomato, cheese..." data-i18n-placeholder="ingredientsPlaceholder" oninput="updateCharCount()"></textarea>
                    <div class="char-count" id="charCount">0 / 500</div>
                    <div class="quick-tags">
                        <button class="tag" onclick="addTag('eggs', this)" type="button"> Eggs</button>
                        <button class="tag" onclick="addTag('chicken', this)" type="button"> Chicken</button>
                        <button class="tag" onclick="addTag('rice', this)" type="button"> Rice</button>
                        <button class="tag" onclick="addTag('tomato', this)" type="button"> Tomato</button>
                        <button class="tag" onclick="addTag('cheese', this)" type="button"> Cheese</button>
                        <button class="tag" onclick="addTag('pasta', this)" type="button"> Pasta</button>
                    </div>
                </div>

                <!-- Dietary Preferences & Allergy Filter -->
                <div class="dietary-section">
                    <label> <span data-i18n="dietaryPrefs">Dietary Preferences</span></label>
                    <div class="dietary-options">
                        <label class="dietary-option"><input type="checkbox" id="vegetarian"><span> Vegetarian</span></label>
                        <label class="dietary-option"><input type="checkbox" id="vegan"><span> Vegan</span></label>
                        <label class="dietary-option"><input type="checkbox" id="lowcal"><span> Low Calorie</span></label>
                        <label class="dietary-option"><input type="checkbox" id="quick"><span> Quick & Easy</span></label>
                        <label class="dietary-option"><input type="checkbox" id="halal"><span> Halal</span></label>
                        <label class="dietary-option"><input type="checkbox" id="keto"><span> Keto</span></label>
                    </div>
                </div>

                <!-- Allergy Alerts -->
                <div class="dietary-section" style="margin-top: -10px;">
                    <label> Allergy Alerts</label>
                    <div class="dietary-options">
                        <label class="dietary-option allergy-option"><input type="checkbox" id="noGluten"><span> Gluten-free</span></label>
                        <label class="dietary-option allergy-option"><input type="checkbox" id="noLactose"><span> Lactose-free</span></label>
                        <label class="dietary-option allergy-option"><input type="checkbox" id="noNuts"><span> Nut-free</span></label>
                        <label class="dietary-option allergy-option"><input type="checkbox" id="noEggs"><span> Egg-free</span></label>
                        <label class="dietary-option allergy-option"><input type="checkbox" id="noShellfish"><span> Shellfish-free</span></label>
                        <label class="dietary-option allergy-option"><input type="checkbox" id="noSoy"><span> Soy-free</span></label>
                    </div>
                </div>

                <!-- Smart Fridge Mode -->
                <div class="fridge-mode-section">
                    <label class="fridge-toggle">
                        <input type="checkbox" id="fridgeMode">
                        <span class="fridge-toggle-label"> Smart Fridge Mode</span>
                        <span class="fridge-toggle-desc">Only use ingredients I have</span>
                    </label>
                </div>

                <!-- Cook Specific Dish (Enhanced) -->
                <div class="cook-specific-section">
                    <div class="cook-specific-label"> <span data-i18n="wantToCook">Want to cook something specific?</span></div>
                    <div class="cook-specific-row">
                        <input type="text" id="specificDish" class="cook-specific-input" placeholder="Plov, Dolma, Pizza..." onkeypress="if(event.key==='Enter')cookSpecificDish()" aria-label="Specific dish name">
                        <button onclick="cookSpecificDish()" class="cook-specific-btn" aria-label="Cook this dish"> <span data-i18n="cook">Cook!</span></button>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="floating-generate">
                    <button class="main-btn" onclick="generateRecipe()" id="generateBtn">
                        <span></span>
                        <span data-i18n="generateRecipe">Generate Recipe</span>
                    </button>
                </div>

                <!-- Results -->
                <div class="results" id="recipeResults"></div>
            </div>

            <!-- Analyze Tab -->
            <div class="tab-content" id="analyzeTab">
                <div class="upload-section">
                    <span class="upload-icon"></span>
                    <h3 class="upload-title" data-i18n="analyzeFood">Analyze Your Food</h3>
                    <p class="upload-subtitle" data-i18n="getCalories">Get calories and healthier alternatives</p>
                    <div class="upload-btns">
                        <button class="upload-btn primary" onclick="startCamera('analyze')">
                            <span></span>
                            <span data-i18n="camera">Camera</span>
                        </button>
                        <button class="upload-btn secondary" onclick="triggerUpload('analyze')">
                            <span></span>
                            <span data-i18n="upload">Upload</span>
                        </button>
                    </div>
                    <input type="file" id="analyzeFileInput" class="file-input" accept="image/*" onchange="handleUpload(event, 'analyze')">
                </div>

                <div class="camera-preview" id="analyzeCameraPreview">
                    <video id="analyzeVideo" autoplay playsinline muted></video>
                    <div class="camera-top-bar">
                        <button class="cam-top-btn" onclick="closeCamera('analyze')"></button>
                        <span class="camera-mode-label">FOOD SCAN</span>
                        <button class="cam-top-btn" onclick="switchCamera('analyze')"></button>
                    </div>
                    <div class="camera-bottom-area">
                        <div class="camera-guide-text">Point at your food</div>
                        <div class="camera-controls">
                            <button class="cam-side-btn" onclick="triggerUpload('analyze')"></button>
                            <button class="capture-btn" onclick="capturePhoto('analyze')"></button>
                            <button class="cam-side-btn" onclick="closeCamera('analyze')"></button>
                        </div>
                    </div>
                </div>

                <div class="image-preview" id="analyzeImagePreview">
                    <img id="analyzeImage" alt="Food to analyze">
                    <button class="remove-img" onclick="removeImage('analyze')"></button>
                </div>

                <div class="detected-box" id="analyzeDetected">
                    <div class="detected-title"> <span data-i18n="detectedFood">Detected Food</span></div>
                    <div class="detected-tags" id="analyzeDetectedTags"></div>
                </div>

                <button class="main-btn analyze" id="analyzeBtn" onclick="analyzeFood()">
                    <span></span>
                    <span data-i18n="analyzeBtn">Analyze Food</span>
                </button>

                <div class="results" id="analyzeResults"></div>
            </div>

            <!-- Meal Plan Tab -->
            <!-- Health Target Tab (Separate) -->
            <div class="tab-content" id="healthTab">
                <div id="healthDashboard"></div>
            </div>

            <!-- Meal Plan Tab -->
            <div class="tab-content" id="mealplanTab">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 class="section-title" style="margin: 0;"> <span data-i18n="mealPlan">Meal Plan</span></h3>
                    <button class="icon-btn" onclick="ShoppingList.generateFromMealPlan()" title="Generate Shopping List"></button>
                </div>
                <div id="mealPlanContainer" class="meal-plan-container"></div>
            </div>

            <!-- Favorites Tab -->
            <div class="tab-content" id="favoritesTab">
                <!-- Shopping List Section -->
                <div style="margin-bottom:20px;">
                    <h3 class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
                        <span> Shopping List</span>
                        <button onclick="ShoppingList.clear()" style="background:none;border:none;color:var(--text-muted);font-size:12px;cursor:pointer;">Clear</button>
                    </h3>
                    <div class="shopping-list-panel" id="shoppingListPanel"></div>
                </div>
                <div class="search-box">
                    <input type="text" id="favSearchInput" class="search-input" placeholder="Search recipes..." oninput="searchFavorites(this.value)">
                </div>
                <div id="favoritesList"></div>
            </div>



            <!-- Settings Tab -->
            <div class="tab-content" id="settingsTab">
                <h3 class="section-title"> <span data-i18n="settings">Settings</span></h3>

                <!-- Account Section -->
                <section class="api-section" style="text-align: center;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <img id="userAvatar" src="" style="width: 40px; height: 40px; border-radius: 50%; background: #e2e8f0; display: none;" onerror="this.style.display='none'">
                        <div style="text-align: left;">
                            <div style="font-weight: 700; color: var(--text-light);" id="userDisplayName">User</div>
                            <div style="font-size: 12px; color: #64748b;">Free Plan</div>
                        </div>
                    </div>
                    <button class="test-btn" onclick="showPremiumModal()" style="width: 100%; background: var(--accent); color: #000; font-weight: 700; margin-bottom: 8px;"> Upgrade to Premium</button>
                    <button class="clear-key-btn" onclick="signOut()" style="width: 100%; padding: 8px;"> Sign Out</button>
                </section>
                <input type="hidden" id="apiKey" value="BACKEND">

                <!-- Dark Mode -->
                <div class="settings-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-light);" data-i18n="darkMode">Dark Mode</div>
                            <div style="font-size: 12px; color: #64748b;" data-i18n="darkModeDesc">Switch between light and dark theme</div>
                        </div>
                        <button class="icon-btn" onclick="toggleDarkMode()" id="darkBtn2"></button>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="settings-item" id="notifSettingsPanel">
                    <div style="font-weight: 600; color: var(--text-light); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                         Notifications
                    </div>
                    <div id="notifPermissionArea"></div>
                    <div id="notifToggles"></div>
                </div>

                <!-- Language -->
                <div class="settings-item">
                    <div style="font-weight: 600; color: var(--text-light); margin-bottom: 10px;" data-i18n="language">Language</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="tag lang-tag selected" data-lang="en" onclick="setLanguage('en')"> English</button>
                        <button class="tag lang-tag" data-lang="az" onclick="setLanguage('az')"> Azrbaycan</button>
                        <button class="tag lang-tag" data-lang="ru" onclick="setLanguage('ru')"> </button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="settings-item">
                    <div style="font-weight: 600; color: var(--text-light); margin-bottom: 10px;"> <span data-i18n="stats">Statistics</span></div>
                    <div id="statsContainer" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;"></div>
                </div>

                <!-- Clear Data -->
                <div class="settings-item">
                    <div style="font-weight: 600; color: var(--text-light); margin-bottom: 10px;" data-i18n="clearData">Clear Data</div>
                    <button class="clear-key-btn" onclick="clearAllData()" style="width: 100%;">
                         <span data-i18n="clearAllData">Clear All Data</span>
                    </button>
                </div>

                <!-- App Info -->
                <div style="margin-top: 20px; text-align: center; color: #64748b; font-size: 12px;">
                    <div>SnapChef v5.0</div>
                    <div style="margin-top: 5px;">Made with </div>
                    <div style="margin-top: 3px; font-size: 10px; color: #94a3b8;">Health Tracking  Notifications  Better UX</div>
                </div>
            </div>
        </div>
    </div>

    <!-- In-App Notification Popup -->
    <div class="in-app-notif" id="inAppNotif">
        <div class="in-app-notif-icon" id="inAppNotifIcon"></div>
        <div class="in-app-notif-body">
            <div class="in-app-notif-title" id="inAppNotifTitle">Reminder</div>
            <div class="in-app-notif-msg" id="inAppNotifMsg">Message</div>
            <button class="in-app-notif-action" id="inAppNotifAction" style="display:none;" onclick="">OK</button>
        </div>
        <button class="in-app-notif-close" onclick="NotifSystem.dismissInApp()"></button>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
        <div class="nav-item active" onclick="switchTab('recipe')" data-tab="recipe" role="button" tabindex="0" aria-label="Recipe tab" onkeypress="if(event.key==='Enter')switchTab('recipe')">
            <span class="nav-icon"><i data-lucide="chef-hat"></i></span>
            <span class="nav-label">Recipe</span>
        </div>
        <div class="nav-item" onclick="switchTab('analyze')" data-tab="analyze" role="button" tabindex="0" aria-label="Analyze tab" onkeypress="if(event.key==='Enter')switchTab('analyze')">
            <span class="nav-icon"><i data-lucide="scan-search"></i></span>
            <span class="nav-label">Analyze</span>
        </div>
        <div class="nav-item" onclick="switchTab('health')" data-tab="health" role="button" tabindex="0" aria-label="Health target tab" onkeypress="if(event.key==='Enter')switchTab('health')">
            <span class="nav-icon"><i data-lucide="heart-pulse"></i></span>
            <span class="nav-label">Health</span>
        </div>
        <div class="nav-item" onclick="switchTab('mealplan')" data-tab="mealplan" role="button" tabindex="0" aria-label="Meal plan tab" onkeypress="if(event.key==='Enter')switchTab('mealplan')">
            <span class="nav-icon"><i data-lucide="calendar-days"></i></span>
            <span class="nav-label">Plan</span>
        </div>
        <div class="nav-item" onclick="switchTab('favorites')" data-tab="favorites" role="button" tabindex="0" aria-label="Favorites tab" onkeypress="if(event.key==='Enter')switchTab('favorites')">
            <span class="nav-icon"><i data-lucide="heart"></i></span>
            <span class="nav-label">Saved</span>
        </div>
        <div class="nav-item" onclick="switchTab('settings')" data-tab="settings" role="button" tabindex="0" aria-label="Settings tab" onkeypress="if(event.key==='Enter')switchTab('settings')">
            <span class="nav-icon"><i data-lucide="settings"></i></span>
            <span class="nav-label">Settings</span>
        </div>
    </nav>

    <canvas id="canvas"></canvas>

    <script>

        // ========================================
        // TRANSLATIONS
        // ========================================
        var TRANSLATIONS = {
            en: {
                onboard1Title: "Scan Ingredients",
                onboard1Desc: "Take a photo of your ingredients and let AI detect them automatically",
                onboard2Title: "Generate Recipes",
                onboard2Desc: "Get personalized recipes based on what you have in your kitchen",
                onboard3Title: "Analyze Nutrition",
                onboard3Desc: "Get detailed nutrition info and healthier alternatives for any meal",
                skip: "Skip",
                next: "Next",
                getStarted: "Get Started",
                goPremium: "Go Premium",
                premiumDesc: "Unlock unlimited recipes and exclusive features",
                premiumF1: "Unlimited recipe generations",
                premiumF2: "No ads experience",
                premiumF3: "Priority AI processing",
                premiumF4: "Offline saved recipes",
                premiumF5: "Meal Planning",
                monthly: "Monthly",
                yearly: "Yearly",
                perMonth: "/month",
                perYear: "/year",
                save50: "Save 50%",
                subscribe: "Subscribe Now",
                maybeLater: "Maybe Later",
                upgradePremium: "Upgrade to Premium",
                unlimitedRecipes: "Unlimited recipes & no ads",
                upgrade: "Upgrade",
                recipesToday: "recipes today",
                recentRecipes: "Recent Recipes",
                scanIngredients: "Scan Your Ingredients",
                takePhoto: "Take a photo or upload an image",
                camera: "Camera",
                upload: "Upload",
                detectedIngredients: "Detected Ingredients",
                yourIngredients: "Your Ingredients",
                ingredientsPlaceholder: "e.g., eggs, tomato, cheese...",
                dietaryPrefs: "Dietary Preferences",
                vegetarian: "Vegetarian",
                vegan: "Vegan",
                lowCal: "Low Calorie",
                quickEasy: "Quick & Easy",
                generateRecipe: "Generate Recipe",
                analyzeFood: "Analyze Your Food",
                getCalories: "Get calories and healthier alternatives",
                analyzeBtn: "Analyze Food",
                recipe: "Recipe",
                analyze: "Analyze",
                saved: "Saved",
                settings: "Settings",
                mealPlan: "Meal Plan",
                listening: "Listening... say your ingredients",
                offline: "You are offline. Some features may not work.",
                tooManyRequests: "Too many requests. Wait",
                getFrom: "Get from",
                noRecipes: "No saved recipes yet",
                noHistory: "No recent recipes",
                dailyLimitReached: "Daily limit reached! Upgrade to Premium for unlimited recipes.",
                recipeGenerated: "Recipe generated!",
                ingredientsDetected: "ingredients detected",
                enterIngredient: "Enter at least one ingredient",
                apiKeyRequired: "API key required",
                darkMode: "Dark Mode",
                darkModeDesc: "Switch between light and dark theme",
                language: "Language",
                clearData: "Clear Data",
                clearAllData: "Clear All Data",
                importRecipe: "Import Recipe",
                importFromURL: "Import from URL",
                buyCredits: "Buy Credits",
                credits: "credits",
                stats: "Statistics",
                breakfast: "Breakfast",
                lunch: "Lunch",
                dinner: "Dinner",
                wantToCook: "Want to cook something specific?",
                cook: "Cook!"
            },
            az: {
                onboard1Title: "nqredientlri Skan Et",
                onboard1Desc: "nqredientlrinizin klini kin v AI onlar avtomatik akar etsin",
                onboard2Title: "Resept Yarat",
                onboard2Desc: "Mtbxinizdki mhsullara sasn frdi reseptlr aln",
                onboard3Title: "Qida Thlili",
                onboard3Desc: "stniln yemk n trafl qida mlumat v salam alternativlr ld edin",
                skip: "Ke",
                next: "Nvbti",
                getStarted: "Bala",
                goPremium: "Premium Al",
                premiumDesc: "Limitsiz reseptlr v eksklziv funksiyalar",
                premiumF1: "Limitsiz resept yaratma",
                premiumF2: "Reklamsz istifad",
                premiumF3: "Prioritet AI emal",
                premiumF4: "Oflayn saxlanm reseptlr",
                premiumF5: "Yemk Planlamas",
                monthly: "Aylq",
                yearly: "llik",
                perMonth: "/ay",
                perYear: "/il",
                save50: "50% Qnat",
                subscribe: "Abun Ol",
                maybeLater: "Sonra Baxaram",
                upgradePremium: "Premium-a Ykslt",
                unlimitedRecipes: "Limitsiz reseptlr v reklamsz",
                upgrade: "Ykslt",
                recipesToday: "resept bu gn",
                recentRecipes: "Son Reseptlr",
                scanIngredients: "nqredientlri Skan Et",
                takePhoto: "kil k v ya ykl",
                camera: "Kamera",
                upload: "Ykl",
                detectedIngredients: "Akar Ediln nqredientlr",
                yourIngredients: "nqredientlriniz",
                ingredientsPlaceholder: "ms., yumurta, pomidor, pendir...",
                dietaryPrefs: "Phriz Seimlri",
                vegetarian: "Vegetarian",
                vegan: "Vegan",
                lowCal: "Az Kalorili",
                quickEasy: "Tez v Asan",
                generateRecipe: "Resept Yarat",
                analyzeFood: "Yemyi Thlil Et",
                getCalories: "Kalori v salam alternativlr ld et",
                analyzeBtn: "Thlil Et",
                recipe: "Resept",
                analyze: "Thlil",
                saved: "Saxlanm",
                settings: "Parametrlr",
                mealPlan: "Yemk Plan",
                listening: "Dinlyirm... inqredientlri sylyin",
                offline: "Oflayn rejimdsiniz. Bzi funksiyalar ilmy bilr.",
                tooManyRequests: "ox soru. Gzlyin",
                getFrom: "Buradan ld edin",
                noRecipes: "Hl saxlanm resept yoxdur",
                noHistory: "Son reseptlr yoxdur",
                dailyLimitReached: "Gndlik limit bitdi! Limitsiz reseptlr n Premium aln.",
                recipeGenerated: "Resept yaradld!",
                ingredientsDetected: "inqredient akar edildi",
                enterIngredient: "n az bir inqredient daxil edin",
                apiKeyRequired: "API aar tlb olunur",
                darkMode: "Qaranlq Rejim",
                darkModeDesc: "Aq v qaranlq tema arasnda keid",
                language: "Dil",
                clearData: "Mlumatlar Sil",
                clearAllData: "Btn Mlumatlar Sil",
                importRecipe: "Resept dxal Et",
                importFromURL: "URL-dn dxal",
                buyCredits: "Kredit Al",
                credits: "kredit",
                stats: "Statistika",
                breakfast: "Shr yemyi",
                lunch: "Gnorta yemyi",
                dinner: "Axam yemyi",
                wantToCook: "Konkret bir yemk biirmk istyirsiniz?",
                cook: "Biir!"
            },
            ru: {
                onboard1Title: " ",
                onboard1Desc: " ,     ",
                onboard2Title: " ",
                onboard2Desc: "     ,     ",
                onboard3Title: " ",
                onboard3Desc: "        ",
                skip: "",
                next: "",
                getStarted: "",
                goPremium: "",
                premiumDesc: "     ",
                premiumF1: "  ",
                premiumF2: " ",
                premiumF3: "  ",
                premiumF4: "  ",
                premiumF5: " ",
                monthly: "",
                yearly: "",
                perMonth: "/",
                perYear: "/",
                save50: " 50%",
                subscribe: "",
                maybeLater: "",
                upgradePremium: "  ",
                unlimitedRecipes: "   ",
                upgrade: "",
                recipesToday: " ",
                recentRecipes: " ",
                scanIngredients: " ",
                takePhoto: "    ",
                camera: "",
                upload: "",
                detectedIngredients: " ",
                yourIngredients: " ",
                ingredientsPlaceholder: "., , , ...",
                dietaryPrefs: " ",
                vegetarian: "",
                vegan: "",
                lowCal: "",
                quickEasy: "  ",
                generateRecipe: " ",
                analyzeFood: " ",
                getCalories: "    ",
                analyzeBtn: "",
                recipe: "",
                analyze: "",
                saved: "",
                settings: "",
                mealPlan: " ",
                listening: "...  ",
                offline: " .     .",
                tooManyRequests: "  . ",
                getFrom: " ",
                noRecipes: "   ",
                noHistory: "  ",
                dailyLimitReached: "  !      .",
                recipeGenerated: " !",
                ingredientsDetected: " ",
                enterIngredient: "    ",
                apiKeyRequired: " API ",
                darkMode: " ",
                darkModeDesc: "     ",
                language: "",
                clearData: " ",
                clearAllData: "  ",
                importRecipe: " ",
                importFromURL: "  URL",
                buyCredits: " ",
                credits: "",
                stats: "",
                breakfast: "",
                lunch: "",
                dinner: "",
                wantToCook: "  - ?",
                cook: "!"
            }
        };

        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        var currentLang = localStorage.getItem('snapchef_lang') || 'en';
        var currentSlide = 0;
        var isPremium = localStorage.getItem('snapchef_premium') === '1';
        var dailyUsage = JSON.parse(localStorage.getItem('snapchef_daily') || '{"date":"","count":0}');
        var recipeHistory = JSON.parse(localStorage.getItem('snapchef_history') || '[]');
        var favorites = JSON.parse(localStorage.getItem('snapchef_favs') || '[]');
        var currentRecipeData = null;

        var baseServings = null;

        function initServings(recipe) {
            baseServings = recipe.servings || 4;
            var el = document.getElementById('servingsValue');
            if (el) el.textContent = baseServings;
        }

        function changeServings(delta) {
            if (!currentRecipeData || !baseServings) return;
            var el = document.getElementById('servingsValue');
            var current = parseInt(el.textContent || baseServings);
            var next = current + delta;
            if (next < 1) return;
            el.textContent = next;
            var factor = next / baseServings;

            // Scale ingredients text by numeric values
            var ingEls = document.querySelectorAll('.ing-item');
            ingEls.forEach(function(node, idx) {
                var original = currentRecipeData.ingredients[idx] || node.textContent;
                var scaled = original.replace(/(\d+\.?\d*)/g, function(m) {
                    var num = parseFloat(m);
                    if (isNaN(num)) return m;
                    var val = Math.round(num * factor * 10) / 10;
                    return val.toString();
                });
                node.textContent = scaled;
            });
        }

        // ========== RECIPE IMAGE FUNCTIONS ==========
        var foodEmojis = {
            'chicken': '', 'pasta': '', 'rice': '', 'salad': '', 'soup': '',
            'fish': '', 'steak': '', 'pizza': '', 'sushi': '', 'bread': '',
            'cake': '', 'egg': '', 'burger': '', 'taco': '', 'curry': '',
            'noodle': '', 'sandwich': '', 'pie': '', 'default': ''
        };

        function getRecipeEmoji(recipeName) {
            var name = (recipeName || '').toLowerCase();
            for (var key in foodEmojis) {
                if (name.indexOf(key) !== -1) return foodEmojis[key];
            }
            return foodEmojis['default'];
        }

        // Food image system - multi-source real photos
        var foodImageCache = {};

        function getRecipeImageURL(recipeName, imageKeyword) {
            var name = (recipeName || 'food').toLowerCase();
            var keyword = imageKeyword || '';
            
            // Extract food keyword if not provided
            if (!keyword) {
                var foodWords = ['chicken','pasta','rice','salad','soup','fish','steak','pizza',
                    'sushi','bread','cake','burger','taco','curry','noodle','sandwich','pie',
                    'egg','beef','pork','lamb','shrimp','salmon','chocolate','pancake','kebab',
                    'plov','dolma','lahmacun','pilaf','biryani','ramen','dumpling'];
                for (var i = 0; i < foodWords.length; i++) {
                    if (name.indexOf(foodWords[i]) !== -1) { keyword = foodWords[i]; break; }
                }
                if (!keyword) keyword = name.split(' ').slice(0, 2).join(' ');
            }

            // Check cache first
            if (foodImageCache[recipeName]) return foodImageCache[recipeName];

            // Try to load real image asynchronously
            loadFoodImage(keyword, recipeName);

            // Return gradient placeholder with recipe name
            return makeFoodPlaceholder(recipeName);
        }

        function makeFoodPlaceholder(name) {
            return 'data:image/svg+xml,' + encodeURIComponent(
                '<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">' +
                '<defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%">' +
                '<stop offset="0%" style="stop-color:#f97316"/>' +
                '<stop offset="100%" style="stop-color:#ea580c"/>' +
                '</linearGradient></defs>' +
                '<rect width="800" height="600" fill="url(#g)"/>' +
                '<text x="400" y="270" text-anchor="middle" font-size="90" fill="white" opacity="0.8"></text>' +
                '<text x="400" y="360" text-anchor="middle" font-size="24" fill="white" font-family="Arial,sans-serif" opacity="0.7">' + 
                (name || '').substring(0, 35) + '</text></svg>'
            );
        }

        function loadFoodImage(keyword, recipeName) {
            if (foodImageCache[recipeName]) return;
            var searchKey = encodeURIComponent(keyword.trim());

            // Source 1: TheMealDB (best quality, limited catalog)
            fetch('https://www.themealdb.com/api/json/v1/1/search.php?s=' + searchKey)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.meals && data.meals.length > 0) {
                        setFoodImage(recipeName, data.meals[0].strMealThumb);
                    } else {
                        // Source 2: TheMealDB by first letter
                        return fetch('https://www.themealdb.com/api/json/v1/1/search.php?f=' + searchKey.charAt(0))
                            .then(function(r) { return r.json(); })
                            .then(function(data2) {
                                if (data2.meals) {
                                    // Find best match
                                    var kw = keyword.toLowerCase();
                                    var best = data2.meals.find(function(m) { 
                                        return m.strMeal.toLowerCase().indexOf(kw) !== -1; 
                                    }) || data2.meals[0];
                                    setFoodImage(recipeName, best.strMealThumb);
                                }
                            });
                    }
                })
                .catch(function() {});
        }

        function setFoodImage(recipeName, url) {
            if (!url) return;
            foodImageCache[recipeName] = url;
            // Update all images for this recipe
            try {
                document.querySelectorAll('img[data-recipe="' + CSS.escape(recipeName) + '"]').forEach(function(img) {
                    var newImg = new Image();
                    newImg.onload = function() {
                        img.src = url;
                        img.style.opacity = '1';
                    };
                    newImg.src = url;
                });
            } catch(e) {
                // CSS.escape not supported, try simpler selector
                document.querySelectorAll('img[data-recipe]').forEach(function(img) {
                    if (img.getAttribute('data-recipe') === recipeName) {
                        img.src = url;
                        img.style.opacity = '1';
                    }
                });
            }
        }

        function getRandomFoodImage() {
            return makeFoodPlaceholder('SnapChef');
        }

        // Fallback image: a solid gradient SVG as data URI
        var fallbackFoodImage = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1'/%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='800' height='600' fill='url(%23g)'/%3E%3Ctext x='400' y='320' text-anchor='middle' font-size='80' fill='white'%3E%3C/text%3E%3C/svg%3E";


        var currentAnalysisData = null;
        var streams = { recipe: null, analyze: null };
        var images = { recipe: null, analyze: null };

        var CONFIG = {
            MAX_IMAGE_SIZE: 4 * 1024 * 1024,
            MAX_INGREDIENTS_LENGTH: 500,
            FREE_DAILY_LIMIT: 5,
            REQUEST_TIMEOUT: 30000
        };

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function escapeHTML(str) {
            if (str == null || str === undefined) return '';
            var div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        function sanitizeInput(input, maxLength) {
            if (!input) return '';
            return String(input).substring(0, maxLength || 500).replace(/</g, '&lt;').trim();
        }

        function safeJsonParse(str, defaultValue) {
            if (!str) return defaultValue || null;
            try {
                var result = JSON.parse(str);
                return result !== null ? result : (defaultValue || null);
            } catch (e) {
                return defaultValue || null;
            }
        }

        function isValidApiKey(key) {
            if (!key || typeof key !== 'string') return false;
            return (key.indexOf('sk-') === 0 || key.indexOf('sk-proj-') === 0) && key.length > 20;
        }

        function t(key) {
            return (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) || TRANSLATIONS.en[key] || key;
        }

        // ========================================
        // TRANSLATION FUNCTIONS
        // ========================================
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
                var key = el.getAttribute('data-i18n');
                if (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) {
                    el.textContent = TRANSLATIONS[currentLang][key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
                var key = el.getAttribute('data-i18n-placeholder');
                if (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) {
                    el.placeholder = TRANSLATIONS[currentLang][key];
                }
            });
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('snapchef_lang', lang);
            applyTranslations();
            document.querySelectorAll('.lang-option').forEach(function(el) {
                el.classList.toggle('active', el.getAttribute('data-lang') === lang);
            });
            document.querySelectorAll('.lang-tag').forEach(function(el) {
                el.classList.toggle('selected', el.getAttribute('data-lang') === lang);
            });
            var dropdown = document.getElementById('langDropdown');
            if (dropdown) dropdown.classList.remove('show');
        }

        function toggleLangDropdown() {
            document.getElementById('langDropdown').classList.toggle('show');
        }

        // ========================================
        // UI FUNCTIONS
        // ========================================
        function toast(msg, icon) {
            var t = document.getElementById('toast');
            if (!t) return;
            t.innerHTML = icon ? '<span>' + icon + '</span> ' + msg : msg;
            t.classList.add('show');
            setTimeout(function() { t.classList.remove('show'); }, 2500);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            var isDark = document.body.classList.contains('dark-mode');
            var btn = document.getElementById('darkBtn');
            var btn2 = document.getElementById('darkBtn2');
            if (btn) btn.textContent = isDark ? '' : '';
            if (btn2) btn2.textContent = isDark ? '' : '';
            localStorage.setItem('snapchef_dark', isDark ? '1' : '0');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(function(c) {
                c.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(function(n) {
                n.classList.toggle('active', n.getAttribute('data-tab') === tab);
            });
            var el = document.getElementById(tab + 'Tab');
            if (el) el.classList.add('active');

            if (tab === 'favorites') renderFavorites();
            if (tab === 'health') { HealthTarget.render(); }
            if (tab === 'favorites') { ShoppingList.render(); }
            if (tab === 'mealplan') { MealPlanner.renderWeek(); }
            if (tab === 'settings') renderStats();
        }

        // ========================================
        // SPLASH & ONBOARDING
        // ========================================
        function hideSplash() {
            setTimeout(function() {
                document.getElementById('splashScreen').classList.add('hidden');
                if (!localStorage.getItem('snapchef_onboarded')) {
                    document.getElementById('onboarding').classList.add('active');
                }
            }, 2000);
        }

        function nextSlide() {
            var slides = document.querySelectorAll('.onboarding-slide');
            var dots = document.querySelectorAll('.onboarding-dot');
            slides[currentSlide].classList.remove('active');
            slides[currentSlide].classList.add('prev');
            dots[currentSlide].classList.remove('active');
            currentSlide++;
            if (currentSlide >= slides.length) {
                skipOnboarding();
                return;
            }
            slides[currentSlide].classList.add('active');
            dots[currentSlide].classList.add('active');
            if (currentSlide === slides.length - 1) {
                document.querySelector('.onboarding-btn.next').textContent = t('getStarted');
            }
        }

        function skipOnboarding() {
            localStorage.setItem('snapchef_onboarded', '1');
            document.getElementById('onboarding').classList.remove('active');
        }

        // ========================================
        // PREMIUM FUNCTIONS
        // ========================================
        function openPremiumModal() {
            document.getElementById('premiumModal').classList.add('active');
        }

        function closePremiumModal() {
            document.getElementById('premiumModal').classList.remove('active');
        }

        function selectPlan(plan) {
            document.querySelectorAll('.premium-plan').forEach(function(el) {
                el.classList.toggle('selected', el.getAttribute('data-plan') === plan);
            });
        }

        function subscribePremium() {
            isPremium = true;
            localStorage.setItem('snapchef_premium', '1');
            closePremiumModal();
            updatePremiumUI();
            toast(t('goPremium') + '!', '');
        }

        function updatePremiumUI() {
            document.getElementById('subBanner').classList.toggle('hidden', isPremium);
            document.getElementById('usageCounter').classList.toggle('hidden', isPremium);
            document.getElementById('premiumBadge').classList.toggle('hidden', !isPremium);
        }

        function checkDailyLimit() {
            var today = new Date().toDateString();
            if (dailyUsage.date !== today) {
                dailyUsage = { date: today, count: 0 };
                localStorage.setItem('snapchef_daily', JSON.stringify(dailyUsage));
            }
            updateUsageUI();
            if (!isPremium && dailyUsage.count >= CONFIG.FREE_DAILY_LIMIT) {
                openPremiumModal();
                return false;
            }
            return true;
        }

        function incrementUsage() {
            dailyUsage.count++;
            localStorage.setItem('snapchef_daily', JSON.stringify(dailyUsage));
            updateUsageUI();
        }

        function updateUsageUI() {
            var count = document.getElementById('usageCount');
            var fill = document.getElementById('usageFill');
            if (count) count.textContent = dailyUsage.count;
            if (fill) {
                var pct = (dailyUsage.count / CONFIG.FREE_DAILY_LIMIT) * 100;
                fill.style.width = Math.min(pct, 100) + '%';
                fill.classList.remove('warning', 'danger');
                if (pct >= 100) fill.classList.add('danger');
                else if (pct >= 60) fill.classList.add('warning');
            }
        }

        // ========================================
        // CREDIT SYSTEM
        // ========================================
        var CreditSystem = {
            credits: parseInt(localStorage.getItem('snapchef_credits') || '10'),

            init: function() {
                this.updateUI();
            },

            getCredits: function() {
                return this.credits;
            },

            useCredits: function(amount) {
                if (isPremium) return true;
                if (this.credits < amount) {
                    this.showBuyModal();
                    return false;
                }
                this.credits -= amount;
                this.save();
                this.updateUI();
                return true;
            },

            addCredits: function(amount) {
                this.credits += amount;
                this.save();
                this.updateUI();
                toast('+' + amount + ' ' + t('credits'), '');
            },

            save: function() {
                localStorage.setItem('snapchef_credits', this.credits.toString());
            },

            updateUI: function() {
                var display = document.getElementById('creditsDisplay');
                if (display) display.textContent = this.credits;
            },

            showBuyModal: function() {
                var modal = document.getElementById('buyCreditsModal');
                if (modal) modal.classList.add('active');
            },

            buyPackage: function(packageType) {
                var packages = {
                    'small': { credits: 50, price: 2.99 },
                    'medium': { credits: 150, price: 6.99 },
                    'large': { credits: 500, price: 19.99 }
                };
                var pkg = packages[packageType];
                if (!pkg) return;

                // Simulated purchase - in real app would connect to payment system
                this.addCredits(pkg.credits);
                toast('Purchase successful!', '');
                var modal = document.getElementById('buyCreditsModal');
                if (modal) modal.classList.remove('active');
            }
        };

        // ========================================
        // RECIPE IMPORTER
        // ========================================
        var RecipeImporter = {
            openImportModal: function() {
                var modal = document.getElementById('importModal');
                if (modal) modal.classList.add('active');
            },

            closeImportModal: function() {
                var modal = document.getElementById('importModal');
                if (modal) modal.classList.remove('active');
            }
        };

        async function importRecipeFromURL() {
            var url = document.getElementById('importURL').value.trim();
            if (!url) {
                toast('Enter a URL', '');
                return;
            }

            var apiKey = getApiKeyOrGuide();
            if (!apiKey) return;

            var loadingInterval = showProgressiveLoading('recipeResults', [
                ' Reading URL...',
                ' Extracting recipe...',
                ' Formatting...'
            ]);

            try {
                var data = await callAI([{
                    role: 'user',
                    content: 'Based on this URL: ' + url + ', generate a realistic recipe. Return JSON: {"name":"Recipe Name","description":"Brief description","ingredients":["item1","item2"],"steps":["Step 1","Step 2"],"prepTime":15,"cookTime":30,"servings":4,"calories":350}'
                }], { response_format: { type: "json_object" } });
                var recipe = JSON.parse(data.response);

                clearInterval(loadingInterval);
                currentRecipeData = recipe;
                displayRecipe(recipe);
                addToHistory(recipe);
                RecipeImporter.closeImportModal();
                document.getElementById('importURL').value = '';
                showConfetti();
                toast('Recipe imported!', '');

            } catch (error) {
                clearInterval(loadingInterval);
                showError('recipeResults', 'api_error');
            }
        }

        // ========================================
        // MEAL PLANNER
        // ========================================
        var MealPlanner = {
            currentWeek: [],

            init: function() {
                var saved = safeJsonParse(localStorage.getItem('snapchef_meal_plan'), []);
                if (saved && Array.isArray(saved) && saved.length === 7) {
                    this.currentWeek = saved;
                } else {
                    this.currentWeek = [];
                    for (var i = 0; i < 7; i++) {
                        this.currentWeek.push({
                            day: i,
                            breakfast: null,
                            lunch: null,
                            dinner: null
                        });
                    }
                }
            },

            addRecipeToDay: function(dayIndex, mealType, recipe) {
                if (dayIndex < 0 || dayIndex > 6) return;
                this.currentWeek[dayIndex][mealType] = recipe;
                this.save();
                this.renderWeek();
                toast('Added to meal plan', '');
            },

            removeRecipe: function(dayIndex, mealType) {
                this.currentWeek[dayIndex][mealType] = null;
                this.save();
                this.renderWeek();
            },

            save: function() {
                localStorage.setItem('snapchef_meal_plan', JSON.stringify(this.currentWeek));
            },

            renderWeek: function() {
                var container = document.getElementById('mealPlanContainer');
                if (!container) return;

                var days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                var self = this;

                var html = '';
                this.currentWeek.forEach(function(day, i) {
                    html += '<div class="meal-plan-day">';
                    html += '<div class="day-header"><h4>' + days[i] + '</h4><span class="day-date">' + self.getDateForDay(i) + '</span></div>';
                    html += '<div class="meal-slots">';
                    html += self.renderMealSlot(i, 'breakfast', day.breakfast, '', t('breakfast'));
                    html += self.renderMealSlot(i, 'lunch', day.lunch, '', t('lunch'));
                    html += self.renderMealSlot(i, 'dinner', day.dinner, '', t('dinner'));
                    html += '</div></div>';
                });

                container.innerHTML = html;
            },

            renderMealSlot: function(dayIndex, mealType, recipe, icon, label) {
                var filled = recipe ? ' filled' : '';
                var imgHtml = '';
                if (recipe) {
                    var imgUrl = recipe.image || getRecipeImageURL(recipe.name, recipe.imageKeyword);
                    // Mark img for async real image loading
                    imgHtml = '<img class="meal-thumb" src="' + imgUrl + '" alt="" onerror="this.style.display=\'none\'">';
                }
                var content = recipe ? 
                    '<div class="meal-name">' + escapeHTML(recipe.name) + '</div><div class="meal-calories">' + (recipe.calories || 0) + ' cal</div>' :
                    '<div class="meal-empty">+ Add ' + label + '</div>';
                var removeBtn = recipe ? '<button class="meal-remove" onclick="event.stopPropagation(); MealPlanner.removeRecipe(' + dayIndex + ', \'' + mealType + '\')"></button>' : '';

                return '<div class="meal-slot' + filled + '" onclick="MealPlanner.openMealSelector(' + dayIndex + ', \'' + mealType + '\')">' +
                    '<span class="meal-icon">' + icon + '</span>' +
                    imgHtml +
                    '<div class="meal-content">' + content + '</div>' +
                    removeBtn + '</div>';
            },

            getDateForDay: function(dayIndex) {
                var today = new Date();
                var dayOfWeek = today.getDay();
                var monday = new Date(today);
                monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                var targetDate = new Date(monday);
                targetDate.setDate(monday.getDate() + dayIndex);
                return targetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            },

            openMealSelector: function(dayIndex, mealType) {
                var modal = document.getElementById('mealSelectorModal');
                if (!modal) return;
                modal.dataset.dayIndex = dayIndex;
                modal.dataset.mealType = mealType;
                modal.classList.add('active');
                this.renderRecipeSelector();
            },

            renderRecipeSelector: function() {
                var list = document.getElementById('recipeSelectorList');
                if (!list) return;

                var recipes = recipeHistory.concat(favorites);

                if (recipes.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div class="empty-title">' + t('noRecipes') + '</div></div>';
                    return;
                }

                var html = '';
                recipes.forEach(function(r, i) {
                    var imgUrl = r.image || getRecipeImageURL(r.name, r.imageKeyword);
                    html += '<div class="recipe-selector-item" onclick="MealPlanner.selectRecipe(' + i + ')">' +
                        '<img class="recipe-selector-thumb" src="' + imgUrl + '" alt="" onerror="this.src=\'' + fallbackFoodImage + '\'">' +
                        '<div class="recipe-info">' +
                        '<div class="recipe-name">' + escapeHTML(r.name) + '</div>' +
                        '<div class="recipe-meta">' + (r.calories || 0) + ' cal  ' + (r.prepTime || 30) + ' min</div>' +
                        '</div></div>';
                });

                list.innerHTML = html;
            },

            selectRecipe: function(index) {
                var modal = document.getElementById('mealSelectorModal');
                var dayIndex = parseInt(modal.dataset.dayIndex);
                var mealType = modal.dataset.mealType;
                var recipes = recipeHistory.concat(favorites);
                var recipe = recipes[index];

                if (recipe) {
                    this.addRecipeToDay(dayIndex, mealType, recipe);
                }
                modal.classList.remove('active');
            }
        };

        // ========================================
        // SHOPPING LIST
        // ========================================
        var ShoppingList = {
            items: safeJsonParse(localStorage.getItem('snapchef_shopping'), []) || [],

            generateFromMealPlan: function() {
                var allIngredients = {};

                MealPlanner.currentWeek.forEach(function(day) {
                    ['breakfast', 'lunch', 'dinner'].forEach(function(meal) {
                        if (day[meal] && day[meal].ingredients) {
                            day[meal].ingredients.forEach(function(ing) {
                                var key = ing.toLowerCase().trim();
                                allIngredients[key] = (allIngredients[key] || 0) + 1;
                            });
                        }
                    });
                });

                this.items = [];
                var self = this;
                Object.keys(allIngredients).forEach(function(ing) {
                    self.items.push({
                        name: ing,
                        quantity: allIngredients[ing],
                        checked: false,
                        category: self.categorizeIngredient(ing)
                    });
                });

                this.save();
                this.showModal();
            },

            categorizeIngredient: function(ingredient) {
                var categories = {
                    'Produce': ['tomato', 'onion', 'garlic', 'lettuce', 'carrot', 'potato', 'pepper', 'cucumber'],
                    'Meat & Seafood': ['chicken', 'beef', 'pork', 'fish', 'salmon', 'shrimp'],
                    'Dairy': ['milk', 'cheese', 'butter', 'yogurt', 'cream', 'egg'],
                    'Grains': ['rice', 'pasta', 'bread', 'flour', 'oats'],
                    'Spices': ['salt', 'pepper', 'cumin', 'paprika', 'oregano']
                };

                for (var category in categories) {
                    if (categories[category].some(function(item) { return ingredient.includes(item); })) {
                        return category;
                    }
                }
                return 'Other';
            },

            save: function() {
                localStorage.setItem('snapchef_shopping', JSON.stringify(this.items));
            },

            showModal: function() {
                var modal = document.getElementById('shoppingModal');
                if (modal) {
                    modal.classList.add('active');
                    this.render();
                }
            },

            render: function() {
                var container = document.getElementById('shoppingListContainer');
                if (!container) return;

                if (this.items.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div class="empty-title">No items yet</div><div class="empty-desc">Add recipes to your meal plan first</div></div>';
                    return;
                }

                var byCategory = {};
                this.items.forEach(function(item, index) {
                    if (!byCategory[item.category]) byCategory[item.category] = [];
                    byCategory[item.category].push({...item, index: index});
                });

                var html = '';
                var self = this;
                Object.keys(byCategory).sort().forEach(function(category) {
                    html += '<div class="shopping-category">';
                    html += '<div class="shopping-category-title"> ' + category + '</div>';
                    byCategory[category].forEach(function(item) {
                        var checked = item.checked ? ' checked' : '';
                        html += '<div class="shopping-item' + checked + '">';
                        html += '<input type="checkbox" ' + (item.checked ? 'checked' : '') + ' onchange="ShoppingList.toggleItem(' + item.index + ')">';
                        html += '<span class="shopping-item-name">' + escapeHTML(item.name) + '</span>';
                        if (item.quantity > 1) {
                            html += '<span class="shopping-item-qty">x' + item.quantity + '</span>';
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                });

                container.innerHTML = html;
            },

            toggleItem: function(index) {
                this.items[index].checked = !this.items[index].checked;
                this.save();
                this.render();
            },

            clearAll: function() {
                this.items = [];
                this.save();
                this.render();
            },

            share: function() {
                var text = ' Shopping List\n\n';
                this.items.forEach(function(item) {
                    text += (item.checked ? '' : '') + ' ' + item.name;
                    if (item.quantity > 1) text += ' (x' + item.quantity + ')';
                    text += '\n';
                });

                if (navigator.share) {
                    navigator.share({ title: 'Shopping List', text: text });
                } else {
                    navigator.clipboard.writeText(text);
                    toast('Copied to clipboard!', '');
                }
            }
        };

        // ========================================
        // HISTORY & FAVORITES
        // ========================================
        function addToHistory(recipe) {
            recipeHistory.unshift({ ...recipe, date: Date.now() });
            if (recipeHistory.length > 10) recipeHistory.pop();
            localStorage.setItem('snapchef_history', JSON.stringify(recipeHistory));
            renderHistory();
        }

        function renderHistory() {
            var list = document.getElementById('historyList');
            var section = document.getElementById('historySection');
            if (!list) return;

            if (!recipeHistory.length) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            var html = '';
            recipeHistory.slice(0, 3).forEach(function(r, i) {
                var date = new Date(r.date).toLocaleDateString();
                var imgUrl = r.image || getRecipeImageURL(r.name, r.imageKeyword);
                html += '<div class="history-item" onclick="loadHistoryRecipe(' + i + ')">' +
                    '<img class="history-img" src="' + imgUrl + '" alt="" onerror="this.src=\'' + fallbackFoodImage + '\'">' +
                    '<div class="history-info">' +
                    '<div class="history-name">' + escapeHTML(r.name) + '</div>' +
                    '<div class="history-date">' + date + '</div>' +
                    '</div>' +
                    '<button class="history-delete" onclick="event.stopPropagation(); deleteHistory(' + i + ')"></button>' +
                    '</div>';
            });
            list.innerHTML = html;
        }

        function loadHistoryRecipe(index) {
            currentRecipeData = recipeHistory[index];
            displayRecipe(currentRecipeData);
            document.getElementById('recipeResults').classList.add('show');
        }

        function deleteHistory(index) {
            recipeHistory.splice(index, 1);
            localStorage.setItem('snapchef_history', JSON.stringify(recipeHistory));
            renderHistory();
            toast('Deleted', '');
        }

        function toggleFavorite() {
            if (!currentRecipeData) return;
            var index = favorites.findIndex(function(f) { return f.name === currentRecipeData.name; });
            if (index > -1) {
                favorites.splice(index, 1);
                toast('Removed from favorites', '');
            } else {
                favorites.push({ ...currentRecipeData, date: Date.now() });
                toast('Added to favorites!', '');
                // Visual feedback
                var card = document.querySelector('.recipe-card');
                if (card) {
                    card.classList.add('success-pulse');
                    setTimeout(function() { card.classList.remove('success-pulse'); }, 700);
                }
                // Haptic feedback if supported
                if (navigator.vibrate) navigator.vibrate(50);
            }
            localStorage.setItem('snapchef_favs', JSON.stringify(favorites));
            displayRecipe(currentRecipeData);
        }

        function renderFavorites() {
            var list = document.getElementById('favoritesList');
            if (!list) return;

            if (!favorites.length) {
                list.innerHTML = renderEmptyFavorites();
                // Re-init lucide icons for the empty state
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            var html = '';
            favorites.forEach(function(r, i) {
                var imgUrl = r.image || getRecipeImageURL(r.name, r.imageKeyword);
                html += '<div class="history-item" onclick="loadFavoriteRecipe(' + i + ')">' +
                    '<img class="history-img" src="' + imgUrl + '" alt="" onerror="this.style.display=\'none\'">' +
                    '<div class="history-info">' +
                    '<div class="history-name">' + escapeHTML(r.name) + '</div>' +
                    '<div class="history-date">' + (r.calories || 0) + ' cal</div>' +
                    '</div>' +
                    '<button class="history-delete" onclick="event.stopPropagation(); deleteFavorite(' + i + ')"></button>' +
                    '</div>';
            });
            list.innerHTML = html;
        }

        function loadFavoriteRecipe(index) {
            currentRecipeData = favorites[index];
            switchTab('recipe');
            displayRecipe(currentRecipeData);
            document.getElementById('recipeResults').classList.add('show');
        }

        function deleteFavorite(index) {
            favorites.splice(index, 1);
            localStorage.setItem('snapchef_favs', JSON.stringify(favorites));
            renderFavorites();
            toast('Deleted', '');
        }

        function searchFavorites(query) {
            var list = document.getElementById('favoritesList');
            if (!list) return;

            var filtered = favorites.filter(function(r) {
                return r.name.toLowerCase().includes(query.toLowerCase());
            });

            if (!filtered.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div class="empty-title">No results</div></div>';
                return;
            }

            var html = '';
            filtered.forEach(function(r, i) {
                var originalIndex = favorites.indexOf(r);
                html += '<div class="history-item" onclick="loadFavoriteRecipe(' + originalIndex + ')">' +
                    '<div class="history-img"></div>' +
                    '<div class="history-info">' +
                    '<div class="history-name">' + escapeHTML(r.name) + '</div>' +
                    '</div></div>';
            });
            list.innerHTML = html;
        }

        // ========================================
        // FIREBASE AUTH & BACKEND PROXY
        // ========================================
        // TODO: Firebase konfiqurasiyasn z layihnizl vz edin
       var firebaseConfig = {
apiKey: "AIzaSyBKam57lgDdcRHbAZ0VkT0cxUkkYfcQzaM",
            authDomain: "snapchef-9dae2.firebaseapp.com",
            projectId: "snapchef-9dae2",
            storageBucket: "snapchef-9dae2.firebasestorage.app",
            messagingSenderId: "937524569480",
            appId: "1:937524569480:web:06bfb0f2c2aa83271b863d"
        };
   
        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();
        var currentUser = null;

        auth.onAuthStateChanged(function(user) {
            currentUser = user;
            updateAuthUI(user);
        });

        function updateAuthUI(user) {
            var loginScreen = document.getElementById('loginScreen');
            var appContainer = document.getElementById('appContainer');
            if (user) {
                if (loginScreen) loginScreen.style.display = 'none';
                if (appContainer) appContainer.style.display = 'flex';
                var nameEl = document.getElementById('userDisplayName');
                if (nameEl) nameEl.textContent = user.displayName || user.email || 'User';
                var avatarEl = document.getElementById('userAvatar');
                if (avatarEl && user.photoURL) avatarEl.src = user.photoURL;
            } else {
                if (loginScreen) loginScreen.style.display = 'flex';
                if (appContainer) appContainer.style.display = 'none';
            }
        }

        async function signInWithGoogle() {
            try {
                var provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                toast('Welcome!', '');
            } catch (e) {
                toast('Login failed: ' + e.message, '');
            }
        }

        async function signInWithEmail() {
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;
            if (!email || !password) { toast('Enter email and password', ''); return; }
            try {
                await auth.signInWithEmailAndPassword(email, password);
                toast('Welcome back!', '');
            } catch (e) {
                if (e.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        toast('Account created!', '');
                    } catch (e2) {
                        toast('Error: ' + e2.message, '');
                    }
                } else {
                    toast('Error: ' + e.message, '');
                }
            }
        }

        function signOut() {
            auth.signOut();
            toast('Signed out', '');
        }

        // Backend API proxy call
        async function callAI(messages, options) {
            options = options || {};
            var idToken = null;
            if (currentUser) {
                try { idToken = await currentUser.getIdToken(); } catch(e) {}
            }
            var body = {
                messages: messages,
                model: options.model || 'gpt-4o-mini',
                max_tokens: options.max_tokens || 1000,
                userId: getDeviceId(),
                idToken: idToken
            };
            if (options.response_format) body.response_format = options.response_format;

            var response = await fetch('/.netlify/functions/ai', {
                method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + idToken },
                body: JSON.stringify(body)
            });
            var data = await response.json();
            if (!response.ok) {
                if (data.error === 'free_limit_exceeded' || data.error === 'Free limit reached') {
                    showPremiumModal();
                    throw new Error('FREE_LIMIT');
                }
                throw new Error(data.error || 'API Error');
            }
            var usg = data._usage || data.usage; if (usg) updateUsageDisplay(usg);
            return data;
        }

        function getDeviceId() {
            var id = localStorage.getItem('snapchef_device_id');
            if (!id) {
                id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('snapchef_device_id', id);
            }
            return id;
        }

        function updateUsageDisplay(usage) {
            var el = document.getElementById('usageCounter');
            if (el) el.textContent = usage.remaining + '/' + usage.limit + ' free';
        }

        // Backward compatibility stubs
        function getApiKey() { return 'BACKEND'; }
        function getApiKeyOrGuide() { return 'BACKEND'; }
        function isValidApiKey() { return true; }
        function testApiKey() { toast('API managed by server', ''); }
        function clearApiKey() { toast('API managed by server', '');
        }

        async function generateRecipe() {
            if (!checkDailyLimit()) return;
            if (!CreditSystem.useCredits(1)) return;

            var ingredients = document.getElementById('ingredients').value.trim();
            if (!ingredients) {
                toast(t('enterIngredient'), '');
                return;
            }

            var apiKey = getApiKeyOrGuide();
            if (!apiKey) return;

            var prefs = getFullDietaryPrefs();

            var prompt = '';
            if (document.getElementById('fridgeMode').checked) {
                prompt = 'Create a recipe using ONLY these ingredients (do not add others): ' + sanitizeInput(ingredients, 500);
            } else {
                prompt = 'Create a recipe using these ingredients: ' + sanitizeInput(ingredients, 500);
            }
            if (prefs.length) prompt += '. Dietary restrictions (MUST follow): ' + prefs.join(', ');
            prompt += '. Return JSON: {"name":"Recipe Name","description":"Brief description","ingredients":["item1 with amount","item2"],"steps":["Detailed step 1","Step 2"],"prepTime":15,"cookTime":30,"servings":4,"calories":350,"imageKeyword":"simple english food name for image search"}';

            var loadingInterval = showProgressiveLoading('recipeResults', [
                ' Analyzing ingredients...',
                ' Creating recipe...',
                ' Calculating nutrition...',
                ' Final touches...'
            ]);
            document.getElementById('generateBtn').disabled = true;

            try {
                var data = await callAI(
                    [{ role: 'user', content: prompt }],
                    { response_format: { type: "json_object" }, max_tokens: 1000 }
                );

                clearInterval(loadingInterval);
                var recipe = JSON.parse(data.response);

                currentRecipeData = recipe;
                displayRecipe(recipe);
                addToHistory(recipe);
                incrementUsage();
                showConfetti();
                toast(t('recipeGenerated'), '');

            } catch (error) {
                clearInterval(loadingInterval);
                if (!navigator.onLine) {
                    showError('recipeResults', 'network');
                } else {
                    showError('recipeResults', 'api_error');
                }
            }

            document.getElementById('generateBtn').disabled = false;
        }

        // Cook Specific Dish Function
        async function cookSpecificDish() {
            var dishName = document.getElementById('specificDish').value.trim();
            if (!dishName) {
                toast('Enter a dish name', '');
                return;
            }

            if (!checkDailyLimit()) return;
            if (!CreditSystem.useCredits(1)) return;

            var apiKey = getApiKeyOrGuide();
            if (!apiKey) return;

            var ingredients = document.getElementById('ingredients').value.trim();
            var prefs = getFullDietaryPrefs();

            var prompt = 'Create a detailed recipe for: ' + sanitizeInput(dishName, 100);
            if (ingredients) {
                if (document.getElementById('fridgeMode').checked) {
                    prompt += '. ONLY use these ingredients (do not add others): ' + sanitizeInput(ingredients, 500);
                } else {
                    prompt += '. Use these available ingredients: ' + sanitizeInput(ingredients, 500);
                }
            }
            if (prefs.length) prompt += '. Dietary restrictions: ' + prefs.join(', ');
            prompt += '. Return JSON: {"name":"Recipe Name","description":"Brief description","ingredients":["item1 with amount","item2"],"steps":["Detailed step 1","Step 2"],"prepTime":15,"cookTime":30,"servings":4,"calories":350,"imageKeyword":"simple english food name for image search"}';

            var loadingInterval = showProgressiveLoading('recipeResults', [
                ' Searching "' + escapeHTML(dishName) + '"...',
                ' Writing recipe...',
                ' Calculating nutrition...',
                ' Ready!'
            ]);
            document.getElementById('generateBtn').disabled = true;

            try {
                var data = await callAI(
                    [{ role: 'user', content: prompt }],
                    { response_format: { type: "json_object" }, max_tokens: 1000 }
                );

                clearInterval(loadingInterval);
                var recipe = JSON.parse(data.response);

                currentRecipeData = recipe;
                displayRecipe(recipe);
                addToHistory(recipe);
                incrementUsage();
                showConfetti();
                toast(t('recipeGenerated'), '');

            } catch (error) {
                clearInterval(loadingInterval);
                if (!navigator.onLine) {
                    showError('recipeResults', 'network');
                } else {
                    showError('recipeResults', 'api_error');
                }
            }

            document.getElementById('generateBtn').disabled = false;
            document.getElementById('specificDish').value = '';
        }

        function displayRecipe(recipe) {
            var isFav = favorites.some(function(f) { return f.name === recipe.name; });

            // Get image URL from saved data or generate from Unsplash
            var imageUrl = recipe.image || getRecipeImageURL(recipe.name, recipe.imageKeyword);

            var html = '<div class="recipe-card">' +
                '<div class="recipe-img-box">' +
                '<img src="' + imageUrl + '" alt="' + escapeHTML(recipe.name) + '" data-recipe="' + escapeHTML(recipe.name) + '" onload="this.style.opacity=1" onerror="this.style.display=\'none\'" style="opacity:0;transition:opacity 0.3s">' +
                '<div class="recipe-overlay">' +
                '<div class="recipe-name">' + escapeHTML(recipe.name) + '</div>' +
                '<div class="recipe-desc">' + escapeHTML(recipe.description || '') + '</div>' +
                '</div>' +
                '<div class="recipe-actions">' +
                '<button class="recipe-action' + (isFav ? ' fav' : '') + '" onclick="toggleFavorite()" title="Favorite">' + (isFav ? '' : '') + '</button>' +
                '<button class="recipe-action" onclick="shareRecipe()" title="Share"></button>' +
                '<button class="recipe-action" onclick="voiceCook.start(currentRecipeData)" title="Voice Cooking Mode" aria-label="Read recipe aloud"></button>' +
                '</div></div>' +
                '<div class="recipe-stats">' +
                '<div class="stat-item"><div class="stat-icon"></div><div class="stat-value">' + (recipe.prepTime || 15) + '</div><div class="stat-label">Prep (min)</div></div>' +
                '<div class="stat-item"><div class="stat-icon"></div><div class="stat-value">' + (recipe.cookTime || 30) + '</div><div class="stat-label">Cook (min)</div></div>' +
                '<div class="stat-item"><div class="stat-icon"></div><div class="servings-control"><button class="serv-btn" onclick="changeServings(-1)" aria-label="Decrease servings"></button><span id="servingsValue" class="stat-value">' + (recipe.servings || 4) + '</span><button class="serv-btn" onclick="changeServings(1)" aria-label="Increase servings">+</button></div><div class="stat-label">Servings</div></div>' +
                '<div class="stat-item"><div class="stat-icon"></div><div class="stat-value">' + (recipe.calories || 350) + '</div><div class="stat-label">Calories</div></div>' +
                '</div>' +
                '<div class="recipe-body">' +
                '<h3 class="section-title"> Ingredients</h3>' +
                '<div class="ingredients-grid">';

            (recipe.ingredients || []).forEach(function(ing) {
                html += '<div class="ing-item">' + escapeHTML(ing) + '</div>';
            });

            html += '</div><h3 class="section-title"> Instructions</h3><div class="steps-list">';

            (recipe.steps || []).forEach(function(step, i) {
                html += '<div class="step-item"><div class="step-num">' + (i + 1) + '</div><div class="step-text">' + escapeHTML(step) + '</div></div>';
            });

            html += '</div>' +
                '<div style="display:flex;gap:8px;margin-top:15px;flex-wrap:wrap;">' +
                '<button class="main-btn" onclick="voiceCook.start(currentRecipeData)" style="flex:1;min-width:45%; background: var(--primary);">' +
                '<span></span><span>Voice Cook</span></button>' +
                '<button class="main-btn" onclick="ShoppingList.addFromRecipe(currentRecipeData)" style="flex:1;min-width:45%; background: var(--accent);">' +
                '<span></span><span>Shopping List</span></button>' +
                '<button class="main-btn" onclick="addToMealPlan()" style="flex:1;min-width:45%; background: var(--secondary);">' +
                '<span></span><span>Add to Plan</span></button>' +
                '<button class="main-btn" onclick="HealthTarget.addMealFromRecipe(currentRecipeData); toast(\'Meal logged! \', \'\');" style="flex:1;min-width:45%; background: var(--secondary);">' +
                '<span></span><span>Log Meal</span></button>' +
                '</div></div></div>';

            document.getElementById('recipeResults').innerHTML = html;
            document.getElementById('recipeResults').classList.add('show');

            // Initialize servings control
            initServings(recipe);

            // Scroll to results
            setTimeout(function() {
                document.getElementById('recipeResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function addToMealPlan() {
            if (!currentRecipeData) return;
            MealPlanner.openMealSelector(0, 'dinner');
        }

        function shareRecipe() {
            if (!currentRecipeData) return;
            var text = ' ' + currentRecipeData.name + '\n\n';
            text += ' Ingredients:\n' + (currentRecipeData.ingredients || []).join('\n') + '\n\n';
            text += ' Steps:\n' + (currentRecipeData.steps || []).map(function(s, i) { return (i + 1) + '. ' + s; }).join('\n');

            if (navigator.share) {
                navigator.share({ title: currentRecipeData.name, text: text });
            } else {
                navigator.clipboard.writeText(text);
                toast('Recipe copied!', '');
            }
        }

        function speakRecipe() {
            if (!currentRecipeData || !('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            var text = currentRecipeData.name + '. ' + (currentRecipeData.description || '') + '. Ingredients: ' + (currentRecipeData.ingredients || []).join(', ');
            var utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        // ========================================
        // FOOD ANALYSIS
        // ========================================
        async function analyzeFood() {
            if (!images.analyze) {
                showError('analyzeResults', 'image_required');
                document.getElementById('analyzeResults').classList.add('show');
                return;
            }

            var apiKey = getApiKeyOrGuide();
            if (!apiKey) return;

            if (!CreditSystem.useCredits(1)) return;

            var loadingInterval = showProgressiveLoading('analyzeResults', [
                ' Analyzing image...',
                ' Identifying food...',
                ' Calculating nutrition...',
                ' Finding healthier alternatives...'
            ]);

            try {
                var data = await callAI([{
                    role: 'user',
                    content: [
                        { type: 'text', text: 'Analyze this food image. Return JSON: {"name":"Food Name","description":"Brief description","calories":350,"protein":20,"carbs":30,"fat":15,"fiber":5,"score":75,"alternatives":[{"name":"Healthier option","calories":250,"benefit":"Why it is better"}]}' },
                        { type: 'image_url', image_url: { url: images.analyze } }
                    ]
                }], { response_format: { type: "json_object" }, max_tokens: 800 });

                clearInterval(loadingInterval);
                var analysis = JSON.parse(data.response);
                displayAnalysis(analysis);
                showConfetti();

            } catch (error) {
                clearInterval(loadingInterval);
                if (!navigator.onLine) {
                    showError('analyzeResults', 'network');
                } else {
                    showError('analyzeResults', 'analysis_failed');
                }
            }
        }

        function displayAnalysis(analysis) {
            var scoreClass = analysis.score >= 70 ? 'good' : (analysis.score >= 40 ? 'moderate' : 'poor');

            var html = '<div class="food-card">' +
                '<div class="food-header">' +
                '<div><div class="food-name">' + escapeHTML(analysis.name) + '</div>' +
                '<div class="food-desc">' + escapeHTML(analysis.description || '') + '</div></div>' +
                '<div class="score-box"><div class="score-circle ' + scoreClass + '">' + analysis.score + '</div><div class="score-label">Health Score</div></div>' +
                '</div>' +
                '<div class="nutrition-grid">' +
                '<div class="nutrition-item"><div class="nutrition-icon"></div><div class="nutrition-value">' + analysis.calories + '</div><div class="nutrition-label">Calories</div></div>' +
                '<div class="nutrition-item"><div class="nutrition-icon"></div><div class="nutrition-value">' + analysis.protein + 'g</div><div class="nutrition-label">Protein</div></div>' +
                '<div class="nutrition-item"><div class="nutrition-icon"></div><div class="nutrition-value">' + analysis.carbs + 'g</div><div class="nutrition-label">Carbs</div></div>' +
                '<div class="nutrition-item"><div class="nutrition-icon"></div><div class="nutrition-value">' + analysis.fat + 'g</div><div class="nutrition-label">Fat</div></div>' +
                '</div></div>';

            if (analysis.alternatives && analysis.alternatives.length) {
                html += '<h3 class="alternatives-title"> Healthier Alternatives</h3><div class="alt-grid">';
                analysis.alternatives.forEach(function(alt) {
                    html += '<div class="alt-card">' +
                        '<div class="alt-name">' + escapeHTML(alt.name) + '</div>' +
                        '<div class="calorie-save"> ' + alt.calories + ' cal</div>' +
                        '<div class="alt-desc">' + escapeHTML(alt.benefit || '') + '</div>' +
                        '</div>';
                });
                html += '</div>';
            }

            document.getElementById('analyzeResults').innerHTML = html;
        }

        // ========================================
        // IMAGE HANDLING
        // ========================================
        function triggerUpload(type) {
            document.getElementById(type + 'FileInput').click();
        }

        function handleUpload(event, type) {
            var file = event.target.files[0];
            if (!file) return;

            if (file.size > CONFIG.MAX_IMAGE_SIZE) {
                toast('Image too large (max 4MB)', '');
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                images[type] = e.target.result;
                document.getElementById(type + 'Image').src = e.target.result;
                document.getElementById(type + 'ImagePreview').classList.add('show');

                if (type === 'analyze') {
                    document.getElementById('analyzeBtn').classList.add('show');
                }

                // Auto-detect ingredients from uploaded image
                detectIngredients(type);
            };
            reader.readAsDataURL(file);
        }

        function removeImage(type) {
            images[type] = null;
            document.getElementById(type + 'ImagePreview').classList.remove('show');
            document.getElementById(type + 'FileInput').value = '';
            if (type === 'analyze') {
                document.getElementById('analyzeBtn').classList.remove('show');
            }
        }

        function startCamera(type) {
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    zoom: { ideal: 1 },
                    advanced: [{ zoom: 1 }]
                } 
            })
                .then(function(stream) {
                    streams[type] = stream;
                    var video = document.getElementById(type + 'Video');
                    video.srcObject = stream;
                    document.getElementById(type + 'CameraPreview').classList.add('active');
                })
                .catch(function() {
                    toast('Camera access denied', '');
                });
        }

        function switchCamera(type) {
            // Close current stream
            if (streams[type]) {
                streams[type].getTracks().forEach(function(t) { t.stop(); });
            }
            // Toggle facing mode
            var currentFacing = (window._cameraFacing && window._cameraFacing[type]) || 'environment';
            var newFacing = currentFacing === 'environment' ? 'user' : 'environment';
            if (!window._cameraFacing) window._cameraFacing = {};
            window._cameraFacing[type] = newFacing;
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: newFacing,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    zoom: { ideal: 1 },
                    advanced: [{ zoom: 1 }]
                } 
            })
                .then(function(stream) {
                    streams[type] = stream;
                    var video = document.getElementById(type + 'Video');
                    video.srcObject = stream;
                })
                .catch(function() {
                    toast('Could not switch camera', '');
                });
        }

        function closeCamera(type) {
            if (streams[type]) {
                streams[type].getTracks().forEach(function(t) { t.stop(); });
                streams[type] = null;
            }
            document.getElementById(type + 'CameraPreview').classList.remove('active');
        }

        function capturePhoto(type) {
            var video = document.getElementById(type + 'Video');
            var canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            images[type] = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById(type + 'Image').src = images[type];
            document.getElementById(type + 'ImagePreview').classList.add('show');

            if (streams[type]) {
                streams[type].getTracks().forEach(function(t) { t.stop(); });
            }
            document.getElementById(type + 'CameraPreview').classList.remove('active');

            if (type === 'analyze') {
                document.getElementById('analyzeBtn').classList.add('show');
            }

            // Auto-detect ingredients from captured photo
            detectIngredients(type);
        }


        // ========================================
        // INGREDIENT DETECTION FROM IMAGE
        // ========================================
        async function detectIngredients(type) {
            if (!images[type]) return;
            
            var detectedBox = document.getElementById(type + 'Detected');
            var tagsContainer = document.getElementById(type + 'DetectedTags');
            if (!detectedBox || !tagsContainer) return;

            // Show loading
            tagsContainer.innerHTML = '<span style="color:#64748b;font-size:13px;"> Analyzing image...</span>';
            detectedBox.classList.add('show');

            try {
                var prompt = type === 'recipe' 
                    ? 'Look at this image and list all food ingredients you can see. Return ONLY a JSON array of ingredient names in English, e.g. ["eggs","tomato","cheese","onion"]. No other text.'
                    : 'What food is in this image? Return ONLY a JSON array of food names, e.g. ["grilled chicken","rice","salad"]. No other text.';

                var data = await callAI([{
                    role: 'user',
                    content: [
                        { type: 'text', text: prompt },
                        { type: 'image_url', image_url: { url: images[type] } }
                    ]
                }], { max_tokens: 300 });

                var response = data.response.trim();
                // Clean the response - extract JSON array
                var match = response.match(/\[.*\]/s);
                if (match) {
                    var ingredients = JSON.parse(match[0]);
                    
                    // Show detected tags
                    tagsContainer.innerHTML = '';
                    ingredients.forEach(function(ing) {
                        var tag = document.createElement('span');
                        tag.className = 'detected-tag';
                        tag.textContent = ing;
                        tag.style.cursor = 'pointer';
                        tag.onclick = function() {
                            if (type === 'recipe') {
                                var ta = document.getElementById('ingredients');
                                if (ta) {
                                    ta.value = ta.value ? ta.value + ', ' + ing : ing;
                                    updateCharCount();
                                }
                            }
                        };
                        tagsContainer.appendChild(tag);
                    });
                    detectedBox.classList.add('show');

                    // Auto-fill ingredients textarea for recipe tab
                    if (type === 'recipe') {
                        var ta = document.getElementById('ingredients');
                        if (ta) {
                            ta.value = ingredients.join(', ');
                            updateCharCount();
                        }
                    }

                    toast(ingredients.length + ' ' + t('ingredientsDetected'), '');
                    
                    // Scroll down to show detected + generate button
                    setTimeout(function() {
                        detectedBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                } else {
                    tagsContainer.innerHTML = '<span style="color:#ef4444;font-size:13px;">Could not detect ingredients. Try a clearer photo.</span>';
                }
            } catch (e) {
                console.error('Detection error:', e);
                if (e.message === 'FREE_LIMIT') {
                    tagsContainer.innerHTML = '<span style="color:#f59e0b;font-size:13px;"> Free limit reached. Upgrade to Premium or type ingredients manually below.</span>';
                } else if (e.message && e.message.includes('403')) {
                    tagsContainer.innerHTML = '<span style="color:#ef4444;font-size:13px;"> API not connected. Please check Settings  API Key.</span>';
                } else {
                    tagsContainer.innerHTML = '<span style="color:#ef4444;font-size:13px;">Detection failed. Type ingredients manually below.</span>';
                }
            }
        }


        // ========================================
        // DIETARY PREFERENCES COLLECTOR
        // ========================================
        function getFullDietaryPrefs() {
            var prefs = [];
            if (document.getElementById('vegetarian').checked) prefs.push('vegetarian');
            if (document.getElementById('vegan').checked) prefs.push('vegan');
            if (document.getElementById('lowcal').checked) prefs.push('low calorie');
            if (document.getElementById('quick').checked) prefs.push('quick and easy (under 30 min)');
            if (document.getElementById('halal').checked) prefs.push('halal (no pork, no alcohol)');
            if (document.getElementById('keto').checked) prefs.push('keto (low carb, high fat)');
            // Allergies
            if (document.getElementById('noGluten').checked) prefs.push('gluten-free (no wheat, barley, rye)');
            if (document.getElementById('noLactose').checked) prefs.push('lactose-free (no milk, cheese, cream)');
            if (document.getElementById('noNuts').checked) prefs.push('nut-free (no peanuts, almonds, walnuts)');
            if (document.getElementById('noEggs').checked) prefs.push('egg-free');
            if (document.getElementById('noShellfish').checked) prefs.push('shellfish-free (no shrimp, crab, lobster)');
            if (document.getElementById('noSoy').checked) prefs.push('soy-free');
            return prefs;
        }

        // ========================================
        // VOICE COOKING ASSISTANT
        // ========================================
        var voiceCook = {
            steps: [],
            current: 0,
            speaking: false,
            synth: window.speechSynthesis,

            start: function(recipe) {
                if (!recipe || !recipe.steps || !recipe.steps.length) {
                    toast('No steps to read', '');
                    return;
                }
                this.steps = recipe.steps;
                this.current = 0;
                this.speaking = false;
                this.render();
                this.speak();
            },

            render: function() {
                var step = this.steps[this.current];
                var total = this.steps.length;
                var dots = '';
                for (var i = 0; i < total; i++) {
                    var cls = i < this.current ? 'done' : (i === this.current ? 'active' : '');
                    dots += '<div class="voice-dot ' + cls + '"></div>';
                }

                var html = '<div class="voice-cook-panel" id="voiceCookPanel">' +
                    '<div class="voice-cook-header">' +
                    '<div class="voice-cook-title"> Voice Cooking</div>' +
                    '<button class="voice-cook-close" onclick="voiceCook.stop()"></button>' +
                    '</div>' +
                    '<div class="voice-step-display">' +
                    '<div class="voice-step-num">Step ' + (this.current + 1) + ' of ' + total + '</div>' +
                    '<div class="voice-step-text">' + escapeHTML(step) + '</div>' +
                    '</div>' +
                    '<div class="voice-controls">' +
                    '<button class="voice-ctrl-btn small" onclick="voiceCook.prev()" ' + (this.current === 0 ? 'disabled style="opacity:0.3"' : '') + '></button>' +
                    '<button class="voice-ctrl-btn small" onclick="voiceCook.repeat()"></button>' +
                    '<button class="voice-ctrl-btn big" onclick="voiceCook.toggleSpeak()" id="voicePlayBtn">' + (this.speaking ? '' : '') + '</button>' +
                    '<button class="voice-ctrl-btn small" onclick="voiceCook.next()" ' + (this.current >= total - 1 ? 'disabled style="opacity:0.3"' : '') + '></button>' +
                    '</div>' +
                    '<div class="voice-progress">' + dots + '</div>' +
                    '</div>';

                var existing = document.getElementById('voiceCookPanel');
                if (existing) {
                    existing.outerHTML = html;
                } else {
                    document.getElementById('recipeResults').insertAdjacentHTML('beforeend', html);
                }
            },

            speak: function() {
                this.synth.cancel();
                var utter = new SpeechSynthesisUtterance(this.steps[this.current]);
                utter.rate = 0.9;
                utter.pitch = 1;
                utter.lang = document.documentElement.lang || 'en';
                var self = this;
                utter.onend = function() {
                    self.speaking = false;
                    self.render();
                };
                this.speaking = true;
                this.synth.speak(utter);
                this.render();
            },

            toggleSpeak: function() {
                if (this.speaking) {
                    this.synth.cancel();
                    this.speaking = false;
                    this.render();
                } else {
                    this.speak();
                }
            },

            next: function() {
                if (this.current < this.steps.length - 1) {
                    this.synth.cancel();
                    this.current++;
                    this.render();
                    this.speak();
                } else {
                    toast(' Recipe complete!', '');
                }
            },

            prev: function() {
                if (this.current > 0) {
                    this.synth.cancel();
                    this.current--;
                    this.render();
                    this.speak();
                }
            },

            repeat: function() {
                this.speak();
            },

            stop: function() {
                this.synth.cancel();
                this.speaking = false;
                var panel = document.getElementById('voiceCookPanel');
                if (panel) panel.remove();
            }
        };

        // ========================================
        // SMART SHOPPING LIST
        // ========================================
        var ShoppingList = {
            items: JSON.parse(localStorage.getItem('snapchef_shopping') || '[]'),

            save: function() {
                localStorage.setItem('snapchef_shopping', JSON.stringify(this.items));
            },

            addFromRecipe: function(recipe) {
                if (!recipe || !recipe.ingredients) return;
                var added = 0;
                var self = this;
                recipe.ingredients.forEach(function(ing) {
                    // Check if already exists
                    var exists = self.items.some(function(item) {
                        return item.text.toLowerCase() === ing.toLowerCase();
                    });
                    if (!exists) {
                        self.items.push({ text: ing, checked: false, recipe: recipe.name });
                        added++;
                    }
                });
                this.save();
                toast(added + ' items added to shopping list', '');
                this.render();
            },

            toggle: function(index) {
                this.items[index].checked = !this.items[index].checked;
                this.save();
                this.render();
            },

            remove: function(index) {
                this.items.splice(index, 1);
                this.save();
                this.render();
            },

            clear: function() {
                this.items = [];
                this.save();
                this.render();
            },

            clearChecked: function() {
                this.items = this.items.filter(function(item) { return !item.checked; });
                this.save();
                this.render();
            },

            share: function() {
                var text = ' Shopping List\n\n';
                this.items.forEach(function(item) {
                    text += (item.checked ? '' : '') + ' ' + item.text + '\n';
                });
                if (navigator.share) {
                    navigator.share({ title: 'Shopping List', text: text });
                } else {
                    navigator.clipboard.writeText(text);
                    toast('List copied!', '');
                }
            },

            render: function() {
                var panel = document.getElementById('shoppingListPanel');
                if (!panel) return;

                if (this.items.length === 0) {
                    panel.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">' +
                        '<div style="font-size:40px;margin-bottom:10px;"></div>' +
                        '<div>Shopping list is empty</div>' +
                        '<div style="font-size:12px;margin-top:5px;">Generate a recipe and tap "Add to Shopping List"</div></div>';
                    return;
                }

                var html = '<div class="shopping-list-title"> Shopping List (' + this.items.length + ' items)</div>';
                var self = this;
                this.items.forEach(function(item, i) {
                    html += '<div class="shopping-item ' + (item.checked ? 'checked' : '') + '">' +
                        '<input type="checkbox" class="shopping-check" ' + (item.checked ? 'checked' : '') + 
                        ' onchange="ShoppingList.toggle(' + i + ')">' +
                        '<span class="shopping-text">' + escapeHTML(item.text) + '</span>' +
                        '<button onclick="ShoppingList.remove(' + i + ')" style="background:none;border:none;cursor:pointer;font-size:16px;opacity:0.5;"></button>' +
                        '</div>';
                });
                html += '<div class="shopping-actions">' +
                    '<button onclick="ShoppingList.share()" style="background:var(--primary);color:white;"> Share</button>' +
                    '<button onclick="ShoppingList.clearChecked()" style="background:#f59e0b;color:white;"> Clear Done</button>' +
                    '<button onclick="ShoppingList.clear()" style="background:#ef4444;color:white;"> Clear All</button>' +
                    '</div>';
                panel.innerHTML = html;
            },

            showPanel: function() {
                var results = document.getElementById('recipeResults');
                var existing = document.getElementById('shoppingListPanel');
                if (existing) { existing.remove(); return; }
                results.insertAdjacentHTML('beforeend', '<div class="shopping-list-panel" id="shoppingListPanel"></div>');
                this.render();
            }
        };

        // ========================================
        // VOICE INPUT
        // ========================================
        var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        var recognition = null;
        var isListening = false;

        function initVoice() {
            if (!SpeechRecognition) {
                document.getElementById('voiceBtn').style.display = 'none';
                return false;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = function(e) {
                var transcript = '';
                for (var i = e.resultIndex; i < e.results.length; i++) {
                    if (e.results[i].isFinal) {
                        transcript = e.results[i][0].transcript;
                    }
                }
                if (transcript) {
                    var ta = document.getElementById('ingredients');
                    if (ta) {
                        ta.value = ta.value ? ta.value + ', ' + transcript : transcript;
                        updateCharCount();
                    }
                }
            };

            recognition.onend = function() {
                isListening = false;
                updateVoiceUI(false);
            };

            recognition.onerror = function() {
                isListening = false;
                updateVoiceUI(false);
            };

            return true;
        }

        function updateVoiceUI(active) {
            var btn = document.getElementById('voiceBtn');
            var ind = document.getElementById('voiceIndicator');
            if (btn) {
                btn.classList.toggle('voice-active', active);
                btn.textContent = active ? '' : '';
            }
            if (ind) ind.classList.toggle('active', active);
        }

        function toggleVoice() {
            if (!recognition && !initVoice()) {
                toast('Voice not supported', '');
                return;
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
                updateVoiceUI(false);
            } else {
                try {
                    recognition.start();
                    isListening = true;
                    updateVoiceUI(true);
                } catch (e) {}
            }
        }

        // ========================================
        // MISC FUNCTIONS
        // ========================================
        function updateCharCount() {
            var ta = document.getElementById('ingredients');
            var cc = document.getElementById('charCount');
            if (!ta || !cc) return;
            cc.textContent = ta.value.length + ' / ' + CONFIG.MAX_INGREDIENTS_LENGTH;
        }

        function addTag(item, btn) {
            var ta = document.getElementById('ingredients');
            if (!ta) return;

            if (btn.classList.contains('selected')) {
                ta.value = ta.value.replace(new RegExp(item + ',?\s*', 'gi'), '').replace(/,\s*,/g, ',').replace(/^,|,$/g, '').trim();
                btn.classList.remove('selected');
            } else {
                ta.value = ta.value ? ta.value + ', ' + item : item;
                btn.classList.add('selected');
            }
            updateCharCount();
        }

        function renderStats() {
            var container = document.getElementById('statsContainer');
            if (!container) return;

            var totalRecipes = recipeHistory.length;
            var totalFavorites = favorites.length;
            var totalCredits = CreditSystem.credits;

            container.innerHTML = 
                '<div class="nutrition-item"><div class="nutrition-icon"></div><div class="nutrition-value">' + totalRecipes + '</div><div class="nutrition-label">Recipes</div></div>' +
                '<div class="nutrition-item"><div class="nutrition-icon"></div><div class="nutrition-value">' + totalFavorites + '</div><div class="nutrition-label">Favorites</div></div>' +
                '<div class="nutrition-item"><div class="nutrition-icon"></div><div class="nutrition-value">' + totalCredits + '</div><div class="nutrition-label">Credits</div></div>' +
                '<div class="nutrition-item"><div class="nutrition-icon"></div><div class="nutrition-value">' + dailyUsage.count + '</div><div class="nutrition-label">Today</div></div>';
        }

        function clearAllData() {
            if (!confirm('Are you sure you want to clear all data?')) return;

            localStorage.removeItem('snapchef_favs');
            localStorage.removeItem('snapchef_history');
            localStorage.removeItem('snapchef_daily');
            localStorage.removeItem('snapchef_meal_plan');
            localStorage.removeItem('snapchef_shopping');
            localStorage.removeItem('snapchef_credits');

            favorites = [];
            recipeHistory = [];
            dailyUsage = { date: '', count: 0 };

            document.getElementById('apiKey').value = '';
            renderFavorites();
            renderHistory();
            MealPlanner.init();
            CreditSystem.init();

            toast('All data cleared', '');
        }

        function updateOnlineStatus() {
            var isOnline = navigator.onLine;
            var ind = document.getElementById('offlineIndicator');
            if (ind) ind.classList.toggle('show', !isOnline);
        }

        // ========================================
        // HEALTH TARGET SYSTEM
        // ========================================
        var HealthTarget = {
            profile: null,
            todayLog: null,

            init: function() {
                this.profile = JSON.parse(localStorage.getItem('snapchef_health_profile') || 'null');
                this.loadTodayLog();
                this.render();
            },

            getToday: function() {
                return new Date().toISOString().split('T')[0];
            },

            loadTodayLog: function() {
                var allLogs = JSON.parse(localStorage.getItem('snapchef_health_logs') || '{}');
                var today = this.getToday();
                if (!allLogs[today]) {
                    allLogs[today] = {
                        calories: 0, protein: 0, carbs: 0, fat: 0,
                        water: 0, meals: [], score: 0
                    };
                }
                this.todayLog = allLogs[today];
            },

            saveTodayLog: function() {
                var allLogs = JSON.parse(localStorage.getItem('snapchef_health_logs') || '{}');
                allLogs[this.getToday()] = this.todayLog;
                localStorage.setItem('snapchef_health_logs', JSON.stringify(allLogs));
            },

            getStreak: function() {
                var allLogs = JSON.parse(localStorage.getItem('snapchef_health_logs') || '{}');
                var streak = 0;
                var d = new Date();
                d.setDate(d.getDate() - 1); // start from yesterday
                while (true) {
                    var key = d.toISOString().split('T')[0];
                    var log = allLogs[key];
                    if (log && log.meals && log.meals.length > 0) {
                        streak++;
                        d.setDate(d.getDate() - 1);
                    } else {
                        break;
                    }
                }
                // check if today has meals too
                if (this.todayLog && this.todayLog.meals && this.todayLog.meals.length > 0) {
                    streak++;
                }
                return streak;
            },

            getMacroTargets: function() {
                if (!this.profile) return { protein: 100, carbs: 250, fat: 65 };
                var cal = this.profile.calories || 2000;
                var goal = this.profile.goal || 'healthy';
                var diet = this.profile.diets || [];

                var proteinPct, carbsPct, fatPct;
                if (diet.indexOf('lowcarb') > -1) {
                    proteinPct = 0.30; carbsPct = 0.20; fatPct = 0.50;
                } else if (diet.indexOf('highprotein') > -1) {
                    proteinPct = 0.40; carbsPct = 0.30; fatPct = 0.30;
                } else if (goal === 'loss') {
                    proteinPct = 0.35; carbsPct = 0.30; fatPct = 0.35;
                } else if (goal === 'gain') {
                    proteinPct = 0.30; carbsPct = 0.45; fatPct = 0.25;
                } else {
                    proteinPct = 0.25; carbsPct = 0.45; fatPct = 0.30;
                }
                return {
                    protein: Math.round((cal * proteinPct) / 4),
                    carbs: Math.round((cal * carbsPct) / 4),
                    fat: Math.round((cal * fatPct) / 9)
                };
            },

            getDailyScore: function() {
                if (!this.profile) return 0;
                var cal = this.profile.calories || 2000;
                var macros = this.getMacroTargets();
                var log = this.todayLog;

                // Calorie accuracy (0-40 pts)
                var calRatio = log.calories / cal;
                var calScore = calRatio <= 0 ? 0 : calRatio <= 1.1 ? Math.min(40, Math.round(calRatio * 40)) : Math.max(0, 40 - Math.round((calRatio - 1.1) * 100));

                // Macro balance (0-30 pts)
                var pRatio = Math.min(1, log.protein / macros.protein);
                var cRatio = Math.min(1, log.carbs / macros.carbs);
                var fRatio = Math.min(1, log.fat / macros.fat);
                var macroScore = Math.round(((pRatio + cRatio + fRatio) / 3) * 30);

                // Water (0-15 pts)
                var waterTarget = this.profile.waterTarget || 8;
                var waterScore = Math.round(Math.min(1, log.water / waterTarget) * 15);

                // Meal count (0-15 pts) - eating 3+ meals is ideal
                var mealScore = Math.min(15, log.meals.length * 5);

                return Math.min(100, calScore + macroScore + waterScore + mealScore);
            },

            getScoreEmoji: function(score) {
                if (score >= 85) return '';
                if (score >= 70) return '';
                if (score >= 50) return '';
                if (score >= 30) return '';
                return '';
            },

            getScoreColor: function(score) {
                if (score >= 85) return '#10b981';
                if (score >= 70) return '#22c55e';
                if (score >= 50) return '#eab308';
                if (score >= 30) return '#f97316';
                return '#ef4444';
            },

            getScoreMessage: function(score) {
                if (score >= 85) return 'Excellent work! ';
                if (score >= 70) return 'Good progress ';
                if (score >= 50) return 'On the right track ';
                if (score >= 30) return 'Needs more attention';
                return 'Start logging your meals!';
            },

            getGoalLabel: function(goal) {
                var labels = { loss: ' Weight Loss', maintain: ' Maintain', gain: ' Muscle Gain', healthy: ' Healthy Eating' };
                return labels[goal] || ' Healthy';
            },

            getGoalClass: function(goal) {
                return goal || 'healthy';
            },

            getDietLabel: function(diet) {
                var labels = {
                    balanced: ' Balanced', lowcarb: ' Low Carb', highprotein: ' High Protein',
                    vegetarian: ' Vegetarian', mediterranean: ' Mediterranean', vegan: ' Vegan'
                };
                return labels[diet] || diet;
            },

            getTips: function() {
                var tips = [];
                var log = this.todayLog;
                var macros = this.getMacroTargets();
                var cal = this.profile ? this.profile.calories : 2000;

                if (log.calories === 0) {
                    tips.push({ icon: '', text: 'No meals logged yet today. Start by adding breakfast!' });
                }
                if (log.protein < macros.protein * 0.5 && log.calories > cal * 0.3) {
                    tips.push({ icon: '', text: 'Protein is low. Add eggs, chicken, or fish to your meals.' });
                }
                if (log.calories > cal * 0.9 && log.meals.length < 3) {
                    tips.push({ icon: '', text: 'Near calorie limit but few meals eaten. Try smaller portions.' });
                }
                if (log.water < 4) {
                    tips.push({ icon: '', text: 'Don\'t forget to drink water! Your goal is ' + (this.profile ? this.profile.waterTarget : 8) + ' glasses.' });
                }
                if (log.calories > cal * 1.2) {
                    tips.push({ icon: '', text: 'You\'ve exceeded your daily calorie target. Be more mindful tomorrow.' });
                }
                if (tips.length === 0) {
                    tips.push({ icon: '', text: 'You\'re doing great! Keep up the balanced nutrition.' });
                }

                // Add goal-specific tip
                var goal = this.profile ? this.profile.goal : 'healthy';
                if (goal === 'loss') tips.push({ icon: '', text: 'For weight loss, choose high-fiber foods: vegetables, fruits, whole grains.' });
                if (goal === 'gain') tips.push({ icon: '', text: 'For muscle gain, balance protein and carbs in every meal.' });

                return tips.slice(0, 3);
            },

            buildRingSVG: function(percent, color, size) {
                size = size || 80;
                var r = (size / 2) - 6;
                var c = 2 * Math.PI * r;
                var offset = c - (Math.min(percent, 100) / 100) * c;
                return '<svg class="ring-svg" width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">' +
                    '<circle class="ring-bg" cx="' + (size/2) + '" cy="' + (size/2) + '" r="' + r + '"/>' +
                    '<circle class="ring-fill" cx="' + (size/2) + '" cy="' + (size/2) + '" r="' + r + '" ' +
                    'stroke="' + color + '" stroke-dasharray="' + c + '" stroke-dashoffset="' + offset + '"/>' +
                    '</svg>';
            },

            render: function() {
                var container = document.getElementById('healthDashboard');
                if (!container) return;

                if (!this.profile) {
                    container.innerHTML = '<div class="health-no-profile">' +
                        '<div class="health-no-profile-icon"></div>' +
                        '<div class="health-no-profile-title">Set Your Health Goal</div>' +
                        '<div class="health-no-profile-desc">Set your daily calorie, macro, and water targets to start eating healthy</div>' +
                        '<button class="health-setup-btn" onclick="HealthTarget.openProfile()"> Get Started</button>' +
                        '</div>';
                    return;
                }

                var log = this.todayLog;
                var cal = this.profile.calories || 2000;
                var macros = this.getMacroTargets();
                var score = this.getDailyScore();
                var streak = this.getStreak();
                var waterTarget = this.profile.waterTarget || 8;
                var tips = this.getTips();

                var calPct = Math.round((log.calories / cal) * 100);
                var protPct = Math.round((log.protein / macros.protein) * 100);
                var carbPct = Math.round((log.carbs / macros.carbs) * 100);
                var fatPct = Math.round((log.fat / macros.fat) * 100);

                var html = '<div class="health-dashboard">';

                // Header
                html += '<div class="health-dash-header">' +
                    '<div class="health-dash-title"> Today\'s Goal</div>' +
                    '<button class="health-edit-btn" onclick="HealthTarget.openProfile()"> Edit</button>' +
                    '</div>';

                // Goal badge + diet
                html += '<div class="health-goal-badge ' + this.getGoalClass(this.profile.goal) + '">' + this.getGoalLabel(this.profile.goal) + '</div>';
                if (this.profile.diets && this.profile.diets.length) {
                    this.profile.diets.forEach(function(d) {
                        html += ' <span class="health-goal-badge healthy" style="font-size:11px;">' + HealthTarget.getDietLabel(d) + '</span>';
                    });
                }

                // Daily Score
                html += '<div class="health-daily-score">' +
                    '<div class="daily-score-circle" style="background:' + this.getScoreColor(score) + ';">' + score + '</div>' +
                    '<div class="daily-score-info">' +
                    '<div class="daily-score-title">' + this.getScoreMessage(score) + '</div>' +
                    '<div class="daily-score-desc">Daily health score</div>' +
                    '</div>' +
                    '<div class="daily-score-streak"> ' + streak + ' days</div>' +
                    '</div>';

                // Progress Rings
                html += '<div class="health-progress-ring">';
                // Calories
                html += '<div class="ring-item">' +
                    this.buildRingSVG(calPct, calPct > 110 ? '#DC3545' : '#6366f1') +
                    '<div class="ring-value">' + log.calories + '</div>' +
                    '<div class="ring-label">Calories /' + cal + '</div></div>';
                // Protein
                html += '<div class="ring-item">' +
                    this.buildRingSVG(protPct, '#f59e0b') +
                    '<div class="ring-value">' + log.protein + 'g</div>' +
                    '<div class="ring-label">Protein /' + macros.protein + 'g</div></div>';
                // Carbs
                html += '<div class="ring-item">' +
                    this.buildRingSVG(carbPct, '#3b82f6') +
                    '<div class="ring-value">' + log.carbs + 'g</div>' +
                    '<div class="ring-label">Carbs /' + macros.carbs + 'g</div></div>';
                // Fat
                html += '<div class="ring-item">' +
                    this.buildRingSVG(fatPct, '#2D6A4F') +
                    '<div class="ring-value">' + log.fat + 'g</div>' +
                    '<div class="ring-label">Fat /' + macros.fat + 'g</div></div>';
                html += '</div>';

                // Water Tracker
                html += '<div class="health-water-section">' +
                    '<div class="water-header">' +
                    '<div class="water-title"> Water Tracker</div>' +
                    '<div class="water-count">' + log.water + '/' + waterTarget + ' glasses</div>' +
                    '</div><div class="water-glasses">';
                for (var i = 0; i < waterTarget; i++) {
                    html += '<div class="water-glass' + (i < log.water ? ' filled' : '') + '" onclick="HealthTarget.toggleWater(' + i + ')">' +
                        (i < log.water ? '' : '') + '</div>';
                }
                html += '</div></div>';

                // Quick Meal Logging
                html += '<div class="health-water-section" style="margin-bottom:14px;">' +
                    '<div class="water-header">' +
                    '<div class="water-title"> Today\'s Meals (' + log.meals.length + ')</div>' +
                    '<button class="health-edit-btn" onclick="HealthTarget.openMealLogger()">+ Add Meal</button>' +
                    '</div>';
                if (log.meals.length > 0) {
                    log.meals.forEach(function(meal, idx) {
                        html += '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);">' +
                            '<div style="display:flex;align-items:center;gap:10px;">' +
                            '<span style="font-size:20px;">' + (meal.icon || '') + '</span>' +
                            '<div><div style="font-weight:600;font-size:13px;color:var(--text-light);">' + escapeHTML(meal.name) + '</div>' +
                            '<div style="font-size:11px;color:#64748b;">' + meal.calories + ' kcal  P:' + (meal.protein || 0) + 'g  C:' + (meal.carbs || 0) + 'g  F:' + (meal.fat || 0) + 'g</div></div>' +
                            '</div>' +
                            '<button style="border:none;background:none;font-size:16px;cursor:pointer;" onclick="HealthTarget.removeMeal(' + idx + ')"></button>' +
                            '</div>';
                    });
                } else {
                    html += '<div style="text-align:center;padding:16px;color:#64748b;font-size:13px;">No meals logged yet</div>';
                }
                html += '</div>';

                // Tips
                html += '<div class="health-tips">' +
                    '<div style="font-weight:600;font-size:13px;margin-bottom:8px;color:var(--text-light);"> Tips</div>';
                tips.forEach(function(tip) {
                    html += '<div class="health-tip"><span class="tip-icon">' + tip.icon + '</span><span>' + tip.text + '</span></div>';
                });
                html += '</div>';

                html += '</div>'; // close dashboard
                container.innerHTML = html;
            },

            toggleWater: function(index) {
                if (index < this.todayLog.water) {
                    this.todayLog.water = index;
                } else {
                    this.todayLog.water = index + 1;
                }
                this.saveTodayLog();
                this.render();
                if (navigator.vibrate) navigator.vibrate(30);
                if (this.todayLog.water >= (this.profile ? this.profile.waterTarget : 8)) {
                    toast('Water goal reached! ', '');
                }
            },

            openProfile: function() {
                var modal = document.getElementById('healthProfileModal');
                modal.classList.add('active');

                // Restore existing values if editing
                if (this.profile) {
                    document.getElementById('calorieSlider').value = this.profile.calories || 2000;
                    document.getElementById('calorieDisplay').textContent = this.profile.calories || 2000;
                    document.getElementById('waterSlider').value = this.profile.waterTarget || 8;
                    document.getElementById('waterDisplay').textContent = this.profile.waterTarget || 8;

                    // Restore goal
                    document.querySelectorAll('.goal-option').forEach(function(el) {
                        el.classList.toggle('selected', el.getAttribute('data-goal') === HealthTarget.profile.goal);
                    });

                    // Restore diets
                    document.querySelectorAll('.diet-chip').forEach(function(el) {
                        el.classList.toggle('selected', HealthTarget.profile.diets && HealthTarget.profile.diets.indexOf(el.getAttribute('data-diet')) > -1);
                    });
                }
            },

            selectGoal: function(goal) {
                document.querySelectorAll('.goal-option').forEach(function(el) {
                    el.classList.toggle('selected', el.getAttribute('data-goal') === goal);
                });
                this._selectedGoal = goal;

                // Auto-adjust calorie recommendation
                var calMap = { loss: 1600, maintain: 2000, gain: 2500, healthy: 2000 };
                document.getElementById('calorieSlider').value = calMap[goal];
                document.getElementById('calorieDisplay').textContent = calMap[goal];
            },

            toggleDiet: function(el) {
                el.classList.toggle('selected');
            },

            saveProfile: function() {
                var goal = this._selectedGoal || null;
                document.querySelectorAll('.goal-option.selected').forEach(function(el) {
                    goal = el.getAttribute('data-goal');
                });

                if (!goal) {
                    toast('Select a goal', '');
                    return;
                }

                var diets = [];
                document.querySelectorAll('.diet-chip.selected').forEach(function(el) {
                    diets.push(el.getAttribute('data-diet'));
                });

                this.profile = {
                    goal: goal,
                    calories: parseInt(document.getElementById('calorieSlider').value),
                    waterTarget: parseInt(document.getElementById('waterSlider').value),
                    diets: diets,
                    createdAt: Date.now()
                };

                localStorage.setItem('snapchef_health_profile', JSON.stringify(this.profile));
                document.getElementById('healthProfileModal').classList.remove('active');
                this.render();
                toast('Health goal saved! ', '');
                showConfetti();
            },

            openMealLogger: function() {
                var html = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:8500;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);" id="mealLogModal" onclick="if(event.target===this)this.remove()">' +
                    '<div class="api-guide-content" style="max-width:400px;" onclick="event.stopPropagation()">' +
                    '<div style="text-align:center;margin-bottom:15px;"><div style="font-size:40px;"></div>' +
                    '<h2 class="premium-title" style="margin-top:8px;">Log a Meal</h2></div>' +

                    '<div class="profile-field"><label>Meal name</label>' +
                    '<input type="text" id="mealLogName" class="profile-input" placeholder="e.g. Chicken salad, Rice bowl..."></div>' +

                    '<div class="profile-field"><label>Meal type</label>' +
                    '<div style="display:flex;gap:8px;flex-wrap:wrap;" id="mealTypeSelector">' +
                    '<div class="diet-chip selected" onclick="HealthTarget._selectMealType(this)" data-icon="" data-type="breakfast"> Breakfast</div>' +
                    '<div class="diet-chip" onclick="HealthTarget._selectMealType(this)" data-icon="" data-type="lunch"> Lunch</div>' +
                    '<div class="diet-chip" onclick="HealthTarget._selectMealType(this)" data-icon="" data-type="dinner"> Dinner</div>' +
                    '<div class="diet-chip" onclick="HealthTarget._selectMealType(this)" data-icon="" data-type="snack"> Snack</div>' +
                    '</div></div>' +

                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">' +
                    '<div class="profile-field"><label> Calories</label>' +
                    '<input type="number" id="mealLogCal" class="profile-input" placeholder="350" min="0"></div>' +
                    '<div class="profile-field"><label> Protein (g)</label>' +
                    '<input type="number" id="mealLogProt" class="profile-input" placeholder="20" min="0"></div>' +
                    '<div class="profile-field"><label> Carbs (g)</label>' +
                    '<input type="number" id="mealLogCarb" class="profile-input" placeholder="30" min="0"></div>' +
                    '<div class="profile-field"><label> Fat (g)</label>' +
                    '<input type="number" id="mealLogFat" class="profile-input" placeholder="15" min="0"></div>' +
                    '</div>' +

                    '<div style="display:flex;gap:8px;margin-top:5px;">' +
                    '<button class="main-btn" style="flex:1;background:linear-gradient(135deg,var(--primary),var(--primary-dark));" onclick="HealthTarget._quickEstimate()"><span></span><span>AI Estimate</span></button>' +
                    '</div>' +

                    '<button class="main-btn" onclick="HealthTarget.addMealFromLogger()" style="margin-top:10px;background:linear-gradient(135deg,#14b8a6,#0d9488);">' +
                    '<span></span><span>Add Meal</span></button>' +
                    '<button class="premium-close" onclick="document.getElementById(\'mealLogModal\').remove()">Cancel</button>' +
                    '</div></div>';

                document.body.insertAdjacentHTML('beforeend', html);
                document.getElementById('mealLogName').focus();
            },

            _selectMealType: function(el) {
                el.parentElement.querySelectorAll('.diet-chip').forEach(function(c) { c.classList.remove('selected'); });
                el.classList.add('selected');
            },

            _quickEstimate: async function() {
                var name = document.getElementById('mealLogName').value.trim();
                if (!name) { toast('Enter a meal name', ''); return; }

                var apiKey = getApiKeyOrGuide();
                if (!apiKey) return;

                toast('AI is estimating...', '');

                try {
                    var data = await callAI(
                        [{ role: 'user', content: 'Estimate nutrition for one serving of "' + sanitizeInput(name, 100) + '". Return ONLY JSON: {"calories":0,"protein":0,"carbs":0,"fat":0}' }],
                        { response_format: { type: "json_object" }, max_tokens: 100 }
                    );
                    var est = JSON.parse(data.response);
                    document.getElementById('mealLogCal').value = est.calories || 0;
                    document.getElementById('mealLogProt').value = est.protein || 0;
                    document.getElementById('mealLogCarb').value = est.carbs || 0;
                    document.getElementById('mealLogFat').value = est.fat || 0;
                    toast('Estimated values filled!', '');
                } catch (e) {
                    toast('Estimation failed', '');
                }
            },

            addMealFromLogger: function() {
                var name = document.getElementById('mealLogName').value.trim();
                if (!name) { toast('Enter a meal name', ''); return; }

                var selectedType = document.querySelector('#mealTypeSelector .diet-chip.selected');
                var icon = selectedType ? selectedType.getAttribute('data-icon') : '';

                var meal = {
                    name: name,
                    icon: icon,
                    calories: parseInt(document.getElementById('mealLogCal').value) || 0,
                    protein: parseInt(document.getElementById('mealLogProt').value) || 0,
                    carbs: parseInt(document.getElementById('mealLogCarb').value) || 0,
                    fat: parseInt(document.getElementById('mealLogFat').value) || 0,
                    time: Date.now()
                };

                this.todayLog.calories += meal.calories;
                this.todayLog.protein += meal.protein;
                this.todayLog.carbs += meal.carbs;
                this.todayLog.fat += meal.fat;
                this.todayLog.meals.push(meal);

                this.saveTodayLog();
                var modal = document.getElementById('mealLogModal');
                if (modal) modal.remove();
                this.render();
                toast(name + ' added! ', '');
                if (navigator.vibrate) navigator.vibrate(50);
            },

            addMealFromRecipe: function(recipe) {
                if (!recipe) return;
                var servings = recipe.servings || 4;
                var meal = {
                    name: recipe.name,
                    icon: '',
                    calories: Math.round((recipe.calories || 350) / servings),
                    protein: Math.round((recipe.protein || 20) / servings),
                    carbs: Math.round((recipe.carbs || 30) / servings),
                    fat: Math.round((recipe.fat || 15) / servings),
                    time: Date.now()
                };

                this.todayLog.calories += meal.calories;
                this.todayLog.protein += meal.protein;
                this.todayLog.carbs += meal.carbs;
                this.todayLog.fat += meal.fat;
                this.todayLog.meals.push(meal);
                this.saveTodayLog();
                this.render();
            },

            removeMeal: function(index) {
                var meal = this.todayLog.meals[index];
                if (meal) {
                    this.todayLog.calories = Math.max(0, this.todayLog.calories - meal.calories);
                    this.todayLog.protein = Math.max(0, this.todayLog.protein - meal.protein);
                    this.todayLog.carbs = Math.max(0, this.todayLog.carbs - meal.carbs);
                    this.todayLog.fat = Math.max(0, this.todayLog.fat - meal.fat);
                    this.todayLog.meals.splice(index, 1);
                    this.saveTodayLog();
                    this.render();
                    toast('Meal removed', '');
                }
            }
        };

        // ========================================
        // NEW: API GUIDE MODAL
        // ========================================
        function showApiGuide() {
            // No longer needed - API is managed by backend
        }

        function saveApiKeyFromGuide() {
            // No longer needed
        }

        function getApiKeyOrGuide() {
            return 'BACKEND';
        }

        // ========================================
        // NEW: PROGRESSIVE LOADING
        // ========================================
        function showProgressiveLoading(containerId, steps) {
            var container = document.getElementById(containerId);
            if (!container) return;

            var html = '<div class="loading-progress">' +
                '<div class="spinner"></div>' +
                '<div class="loading-steps">';
            
            steps.forEach(function(step, i) {
                html += '<div class="loading-step' + (i === 0 ? ' active' : '') + '" id="loadStep' + i + '">' +
                    '<div class="loading-step-icon">' + (i === 0 ? '' : '') + '</div>' +
                    '<span>' + step + '</span></div>';
            });

            html += '</div></div>';
            container.innerHTML = html;
            container.classList.add('show');

            // Auto-advance steps
            var currentStep = 0;
            var interval = setInterval(function() {
                if (currentStep < steps.length - 1) {
                    var prev = document.getElementById('loadStep' + currentStep);
                    if (prev) {
                        prev.classList.remove('active');
                        prev.classList.add('done');
                        prev.querySelector('.loading-step-icon').textContent = '';
                    }
                    currentStep++;
                    var next = document.getElementById('loadStep' + currentStep);
                    if (next) {
                        next.classList.add('active');
                        next.querySelector('.loading-step-icon').textContent = '';
                    }
                } else {
                    clearInterval(interval);
                }
            }, 2500);

            return interval;
        }

        // ========================================
        // NEW: CONFETTI EFFECT
        // ========================================
        function showConfetti() {
            var container = document.getElementById('confettiContainer');
            if (!container) return;
            
            var colors = ['#6366f1', '#2D6A4F', '#14b8a6', '#E8954A', '#2D6A4F', '#4f46e5'];
            var html = '';
            
            for (var i = 0; i < 40; i++) {
                var color = colors[Math.floor(Math.random() * colors.length)];
                var left = Math.random() * 100;
                var delay = Math.random() * 1;
                var size = Math.random() * 8 + 6;
                var shapes = ['border-radius: 50%', 'border-radius: 2px', 'border-radius: 50%; width:' + size + 'px; height:' + (size * 0.4) + 'px'];
                var shape = shapes[Math.floor(Math.random() * shapes.length)];
                
                html += '<div class="confetti-piece" style="left:' + left + '%; background:' + color + 
                    '; animation-delay:' + delay + 's; width:' + size + 'px; height:' + size + 'px; ' + shape + '"></div>';
            }
            
            container.innerHTML = html;
            setTimeout(function() { container.innerHTML = ''; }, 3000);
        }

        // ========================================
        // NEW: BETTER ERROR DISPLAY
        // ========================================
        function showError(containerId, type) {
            var errors = {
                'api_key': {
                    icon: '',
                    title: 'API Key Not Found',
                    desc: 'An OpenAI API key is required to generate recipes. Enter it in Settings.',
                    action: 'Enter API Key',
                    handler: 'showApiGuide()'
                },
                'network': {
                    icon: '',
                    title: 'No Internet Connection',
                    desc: 'This feature requires an internet connection. Please check your network.',
                    action: 'Retry',
                    handler: 'updateOnlineStatus()'
                },
                'api_error': {
                    icon: '',
                    title: 'API Error',
                    desc: 'Could not connect to OpenAI. Make sure your API key is valid.',
                    action: 'Check API Key',
                    handler: 'switchTab("settings")'
                },
                'rate_limit': {
                    icon: '',
                    title: 'Too Many Requests',
                    desc: 'Please wait and try again. If daily limit is reached, upgrade to Premium.',
                    action: 'Go Premium',
                    handler: 'openPremiumModal()'
                },
                'image_required': {
                    icon: '',
                    title: 'Image Required',
                    desc: 'Take or upload a photo of the food to analyze it.',
                    action: null,
                    handler: null
                },
                'analysis_failed': {
                    icon: '',
                    title: 'Analysis Failed',
                    desc: 'Could not identify the food. Try taking a clearer photo.',
                    action: 'Try Again',
                    handler: 'removeImage("analyze")'
                }
            };

            var err = errors[type] || { icon: '', title: 'Xta', desc: 'Namlum xta ba verdi.', action: null };
            
            var html = '<div class="error-box">' +
                '<div class="error-icon">' + err.icon + '</div>' +
                '<div class="error-title">' + err.title + '</div>' +
                '<div class="error-desc">' + err.desc + '</div>';
            
            if (err.action && err.handler) {
                html += '<button class="error-action" onclick="' + err.handler + '">' + err.action + '</button>';
            }
            html += '</div>';

            var container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = html;
                container.classList.add('show');
            }
        }

        // ========================================
        // NEW: BETTER EMPTY STATES
        // ========================================
        function renderEmptyFavorites() {
            return '<div class="empty-state">' +
                '<div class="empty-icon"><i data-lucide="heart" style="width:48px;height:48px;color:var(--text-muted)"></i></div>' +
                '<div class="empty-title">' + t('noRecipes') + '</div>' +
                '<div class="empty-desc">Tap the  button on any recipe to save it here</div>' +
                '<button class="empty-state-action" onclick="switchTab(\'recipe\')"> Create Recipe</button>' +
                '</div>';
        }

        // ========================================
        // NOTIFICATION SYSTEM
        // ========================================
        var NotifSystem = {
            settings: null,
            timers: [],
            inAppQueue: [],
            isShowingInApp: false,

            DEFAULTS: {
                water: { enabled: true, interval: 60 },
                meals: { enabled: true, times: ['08:00', '13:00', '19:00'] },
                summary: { enabled: true, time: '21:00' },
                tips: { enabled: true, interval: 120 }
            },

            init: function() {
                this.settings = JSON.parse(localStorage.getItem('snapchef_notif_settings') || 'null') || JSON.parse(JSON.stringify(this.DEFAULTS));
                this.renderSettingsPanel();
                this.startScheduler();
            },

            save: function() {
                localStorage.setItem('snapchef_notif_settings', JSON.stringify(this.settings));
            },

            // ---- Permission Management ----
            getPermissionStatus: function() {
                if (!('Notification' in window)) return 'unsupported';
                return Notification.permission; // 'granted', 'denied', 'default'
            },

            requestPermission: function() {
                var self = this;
                if (!('Notification' in window)) {
                    toast('Browser notifications not supported', '');
                    return;
                }
                Notification.requestPermission().then(function(perm) {
                    if (perm === 'granted') {
                        toast('Notifications enabled! ', '');
                        self.sendBrowserNotif('SnapChef ', 'Notifications are now active! You\'ll get reminders for water, meals, and more.', '');
                    } else if (perm === 'denied') {
                        toast('Notifications blocked. Enable in browser settings.', '');
                    }
                    self.renderSettingsPanel();
                });
            },

            // ---- Settings Panel Rendering ----
            renderSettingsPanel: function() {
                var permArea = document.getElementById('notifPermissionArea');
                var togglesArea = document.getElementById('notifToggles');
                if (!permArea || !togglesArea) return;

                var perm = this.getPermissionStatus();

                // Permission banner
                if (perm === 'default') {
                    permArea.innerHTML = '<div class="notif-permission-banner">' +
                        '<div style="font-size:24px;margin-bottom:6px;"></div>' +
                        '<div style="font-weight:700;font-size:14px;color:#92400e;">Enable Notifications</div>' +
                        '<div style="font-size:12px;color:#a16207;margin-top:4px;">Get reminders for water, meals, and daily health tips</div>' +
                        '<button class="notif-permission-btn" onclick="NotifSystem.requestPermission()">Allow Notifications</button>' +
                        '</div>';
                } else if (perm === 'denied') {
                    permArea.innerHTML = '<div class="notif-permission-banner" style="background:linear-gradient(135deg,#fee2e2,#fecaca);border-color:#fca5a5;">' +
                        '<div style="font-size:24px;margin-bottom:6px;"></div>' +
                        '<div style="font-weight:700;font-size:14px;color:#991b1b;">Notifications Blocked</div>' +
                        '<div style="font-size:12px;color:#b91c1c;margin-top:4px;">Enable in your browser settings to receive reminders</div>' +
                        '</div>';
                } else if (perm === 'unsupported') {
                    permArea.innerHTML = '<div style="text-align:center;padding:10px;color:#64748b;font-size:12px;">Browser notifications not supported. In-app reminders will still work.</div>';
                } else {
                    permArea.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:8px 0;margin-bottom:8px;">' +
                        '<div style="width:8px;height:8px;border-radius:50%;background:#22c55e;"></div>' +
                        '<div style="font-size:12px;color:#22c55e;font-weight:600;">Notifications active</div></div>';
                }

                // Toggle rows
                var s = this.settings;
                var html = '';

                // 1. Water reminders
                html += '<div class="notif-toggle-row">' +
                    '<div class="notif-toggle-info">' +
                    '<div class="notif-toggle-icon" style="background:#dbeafe;"></div>' +
                    '<div><div class="notif-toggle-text">Water Reminders</div>' +
                    '<div class="notif-toggle-desc">Remind every ' + s.water.interval + ' min to drink water</div>' +
                    '<div class="notif-time-picker">' +
                    '<div class="notif-time-btn' + (s.water.interval === 30 ? ' selected' : '') + '" onclick="NotifSystem.setWaterInterval(30)">30m</div>' +
                    '<div class="notif-time-btn' + (s.water.interval === 60 ? ' selected' : '') + '" onclick="NotifSystem.setWaterInterval(60)">1h</div>' +
                    '<div class="notif-time-btn' + (s.water.interval === 90 ? ' selected' : '') + '" onclick="NotifSystem.setWaterInterval(90)">1.5h</div>' +
                    '<div class="notif-time-btn' + (s.water.interval === 120 ? ' selected' : '') + '" onclick="NotifSystem.setWaterInterval(120)">2h</div>' +
                    '</div></div></div>' +
                    '<label class="notif-switch"><input type="checkbox" ' + (s.water.enabled ? 'checked' : '') + ' onchange="NotifSystem.toggle(\'water\', this.checked)"><span class="notif-slider"></span></label>' +
                    '</div>';

                // 2. Meal time reminders
                html += '<div class="notif-toggle-row">' +
                    '<div class="notif-toggle-info">' +
                    '<div class="notif-toggle-icon" style="background:#fef3c7;"></div>' +
                    '<div><div class="notif-toggle-text">Meal Reminders</div>' +
                    '<div class="notif-toggle-desc">Breakfast ' + s.meals.times[0] + '  Lunch ' + s.meals.times[1] + '  Dinner ' + s.meals.times[2] + '</div>' +
                    '</div></div>' +
                    '<label class="notif-switch"><input type="checkbox" ' + (s.meals.enabled ? 'checked' : '') + ' onchange="NotifSystem.toggle(\'meals\', this.checked)"><span class="notif-slider"></span></label>' +
                    '</div>';

                // 3. Daily summary
                html += '<div class="notif-toggle-row">' +
                    '<div class="notif-toggle-info">' +
                    '<div class="notif-toggle-icon" style="background:#ede9fe;"></div>' +
                    '<div><div class="notif-toggle-text">Daily Summary</div>' +
                    '<div class="notif-toggle-desc">Evening recap at ' + s.summary.time + ' with your health score</div>' +
                    '</div></div>' +
                    '<label class="notif-switch"><input type="checkbox" ' + (s.summary.enabled ? 'checked' : '') + ' onchange="NotifSystem.toggle(\'summary\', this.checked)"><span class="notif-slider"></span></label>' +
                    '</div>';

                // 4. Health tips
                html += '<div class="notif-toggle-row">' +
                    '<div class="notif-toggle-info">' +
                    '<div class="notif-toggle-icon" style="background:#dcfce7;"></div>' +
                    '<div><div class="notif-toggle-text">Health Tips</div>' +
                    '<div class="notif-toggle-desc">Smart nutrition tips every ' + (s.tips.interval / 60) + 'h based on your goals</div>' +
                    '</div></div>' +
                    '<label class="notif-switch"><input type="checkbox" ' + (s.tips.enabled ? 'checked' : '') + ' onchange="NotifSystem.toggle(\'tips\', this.checked)"><span class="notif-slider"></span></label>' +
                    '</div>';

                togglesArea.innerHTML = html;
            },

            // ---- Toggle & Settings ----
            toggle: function(type, enabled) {
                this.settings[type].enabled = enabled;
                this.save();
                this.restartScheduler();
                if (enabled) toast(this._getTypeName(type) + ' enabled', '');
                else toast(this._getTypeName(type) + ' disabled', '');
            },

            setWaterInterval: function(minutes) {
                this.settings.water.interval = minutes;
                this.save();
                this.renderSettingsPanel();
                this.restartScheduler();
                toast('Water reminder: every ' + minutes + ' min', '');
            },

            _getTypeName: function(type) {
                var names = { water: 'Water reminders', meals: 'Meal reminders', summary: 'Daily summary', tips: 'Health tips' };
                return names[type] || type;
            },

            // ---- Scheduler ----
            startScheduler: function() {
                var self = this;
                this.clearTimers();

                // Water reminder interval
                if (this.settings.water.enabled) {
                    var waterTimer = setInterval(function() {
                        self.checkWaterReminder();
                    }, this.settings.water.interval * 60 * 1000);
                    this.timers.push(waterTimer);

                    // Also check once after 5 seconds for initial load
                    setTimeout(function() { self.checkWaterReminder(); }, 5000);
                }

                // Meal time checker  check every minute
                if (this.settings.meals.enabled) {
                    var mealTimer = setInterval(function() {
                        self.checkMealReminder();
                    }, 60 * 1000);
                    this.timers.push(mealTimer);
                }

                // Daily summary checker  check every minute
                if (this.settings.summary.enabled) {
                    var summaryTimer = setInterval(function() {
                        self.checkSummaryReminder();
                    }, 60 * 1000);
                    this.timers.push(summaryTimer);
                }

                // Health tips interval
                if (this.settings.tips.enabled) {
                    var tipsTimer = setInterval(function() {
                        self.sendRandomTip();
                    }, this.settings.tips.interval * 60 * 1000);
                    this.timers.push(tipsTimer);
                }
            },

            restartScheduler: function() {
                this.clearTimers();
                this.startScheduler();
            },

            clearTimers: function() {
                this.timers.forEach(function(t) { clearInterval(t); });
                this.timers = [];
            },

            // ---- Reminder Logic ----
            checkWaterReminder: function() {
                var profile = HealthTarget.profile;
                if (!profile) return;
                var log = HealthTarget.todayLog;
                var target = profile.waterTarget || 8;
                var current = log ? log.water : 0;
                if (current >= target) return; // Goal reached

                var remaining = target - current;
                var messages = [
                    { title: 'Time to hydrate! ', msg: 'You\'ve had ' + current + '/' + target + ' glasses. Drink some water!' },
                    { title: 'Water break! ', msg: remaining + ' more glasses to reach your goal. Keep going!' },
                    { title: 'Stay hydrated! ', msg: 'Your body needs water. ' + current + ' down, ' + remaining + ' to go!' }
                ];
                var pick = messages[Math.floor(Math.random() * messages.length)];
                this.sendNotification('', pick.title, pick.msg, 'switchTab("health")');
            },

            checkMealReminder: function() {
                var now = new Date();
                var hh = String(now.getHours()).padStart(2, '0');
                var mm = String(now.getMinutes()).padStart(2, '0');
                var currentTime = hh + ':' + mm;

                var times = this.settings.meals.times;
                var sentKey = 'snapchef_meal_notif_' + new Date().toISOString().split('T')[0];
                var sent = JSON.parse(localStorage.getItem(sentKey) || '[]');

                var mealNames = ['Breakfast', 'Lunch', 'Dinner'];
                var mealIcons = ['', '', ''];
                var mealTips = [
                    'A healthy breakfast boosts your energy for the day!',
                    'Time for a balanced lunch to keep you going!',
                    'Keep dinner light and nutritious!'
                ];

                for (var i = 0; i < times.length; i++) {
                    if (currentTime === times[i] && sent.indexOf(times[i]) === -1) {
                        // Check if meal already logged for this period
                        var log = HealthTarget.todayLog;
                        var mealTypeMap = ['breakfast', 'lunch', 'dinner'];
                        var alreadyLogged = log && log.meals && log.meals.some(function(m) { return m.type === mealTypeMap[i]; });

                        if (!alreadyLogged) {
                            this.sendNotification(mealIcons[i], mealNames[i] + ' time!', mealTips[i], 'switchTab("health")');
                            sent.push(times[i]);
                            localStorage.setItem(sentKey, JSON.stringify(sent));
                        }
                    }
                }
            },

            checkSummaryReminder: function() {
                var now = new Date();
                var hh = String(now.getHours()).padStart(2, '0');
                var mm = String(now.getMinutes()).padStart(2, '0');
                var currentTime = hh + ':' + mm;

                if (currentTime !== this.settings.summary.time) return;

                var sentKey = 'snapchef_summary_' + new Date().toISOString().split('T')[0];
                if (localStorage.getItem(sentKey)) return;

                var log = HealthTarget.todayLog;
                var profile = HealthTarget.profile;
                if (!profile || !log) return;

                var score = HealthTarget.getDailyScore();
                var cal = profile.calorieTarget || 2000;
                var pct = Math.round((log.calories / cal) * 100);
                var mealCount = log.meals ? log.meals.length : 0;
                var waterTarget = profile.waterTarget || 8;

                var msg = 'Score: ' + score + '/100  ' + log.calories + '/' + cal + ' kcal (' + pct + '%)  ' +
                    mealCount + ' meals  ' + log.water + '/' + waterTarget + ' ';

                var emoji = score >= 80 ? '' : score >= 60 ? '' : score >= 40 ? '' : '';

                this.sendNotification('', 'Daily Summary ' + emoji, msg, 'switchTab("health")');
                localStorage.setItem(sentKey, '1');
            },

            sendRandomTip: function() {
                var tips = [
                    { icon: '', title: 'Eat more greens!', msg: 'Adding vegetables to every meal improves nutrition and keeps you full longer.' },
                    { icon: '', title: 'Protein power!', msg: 'Include protein in each meal to maintain muscle and control appetite.' },
                    { icon: '', title: 'Move more!', msg: 'A 10-minute walk after meals helps digestion and blood sugar control.' },
                    { icon: '', title: 'Sleep well!', msg: 'Good sleep is essential for metabolism and healthy eating habits.' },
                    { icon: '', title: 'Snack smart!', msg: 'Choose fruits, nuts, or yogurt instead of processed snacks.' },
                    { icon: '', title: 'Cook at home!', msg: 'Home-cooked meals are usually healthier and more nutritious.' },
                    { icon: '', title: 'Skip sugary drinks!', msg: 'Replace soda and juice with water, tea, or sparkling water.' },
                    { icon: '', title: 'Fiber is key!', msg: 'High-fiber foods keep you full and support digestive health.' },
                    { icon: '', title: 'Mindful eating!', msg: 'Eat slowly and without distractions  you\'ll feel fuller with less food.' },
                    { icon: '', title: 'Omega-3 boost!', msg: 'Eat fish 2x per week for heart and brain health.' }
                ];

                var profile = HealthTarget.profile;
                if (profile) {
                    if (profile.goal === 'loss') {
                        tips.push({ icon: '', title: 'Weight loss tip', msg: 'Use smaller plates to naturally reduce portion sizes.' });
                        tips.push({ icon: '', title: 'Low-calorie fill', msg: 'Start meals with a salad or soup to eat fewer total calories.' });
                    }
                    if (profile.goal === 'gain') {
                        tips.push({ icon: '', title: 'Muscle fuel', msg: 'Eat protein within 30 minutes after exercise for best recovery.' });
                        tips.push({ icon: '', title: 'Calorie boost', msg: 'Add nuts, nut butter, or avocado for healthy calorie-dense foods.' });
                    }
                }

                var pick = tips[Math.floor(Math.random() * tips.length)];
                this.sendNotification(pick.icon, pick.title, pick.msg);
            },

            // ---- Send Notification (Browser + In-App) ----
            sendNotification: function(icon, title, message, action) {
                // Always send in-app
                this.showInApp(icon, title, message, action);

                // Try browser notification if granted
                if (this.getPermissionStatus() === 'granted' && document.hidden) {
                    this.sendBrowserNotif(title, message, icon);
                }
            },

            sendBrowserNotif: function(title, body, icon) {
                try {
                    var notif = new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">' + (icon || '') + '</text></svg>',
                        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90"></text></svg>',
                        tag: 'snapchef-' + Date.now(),
                        requireInteraction: false
                    });
                    notif.onclick = function() {
                        window.focus();
                        notif.close();
                    };
                    setTimeout(function() { notif.close(); }, 8000);
                } catch (e) {
                    console.log('Browser notification failed:', e);
                }
            },

            // ---- In-App Notification ----
            showInApp: function(icon, title, message, action) {
                this.inAppQueue.push({ icon: icon, title: title, message: message, action: action });
                if (!this.isShowingInApp) this._showNextInApp();
            },

            _showNextInApp: function() {
                if (this.inAppQueue.length === 0) {
                    this.isShowingInApp = false;
                    return;
                }
                this.isShowingInApp = true;
                var item = this.inAppQueue.shift();
                var el = document.getElementById('inAppNotif');
                var iconEl = document.getElementById('inAppNotifIcon');
                var titleEl = document.getElementById('inAppNotifTitle');
                var msgEl = document.getElementById('inAppNotifMsg');
                var actionBtn = document.getElementById('inAppNotifAction');

                iconEl.textContent = item.icon;
                titleEl.textContent = item.title;
                msgEl.textContent = item.message;

                if (item.action) {
                    actionBtn.style.display = 'inline-block';
                    actionBtn.textContent = item.action.indexOf('health') !== -1 ? 'View Health' : 'Open';
                    actionBtn.setAttribute('onclick', item.action + '; NotifSystem.dismissInApp();');
                } else {
                    actionBtn.style.display = 'none';
                }

                el.classList.add('show');
                if (navigator.vibrate) navigator.vibrate([50, 30, 50]);

                var self = this;
                this._dismissTimer = setTimeout(function() {
                    self.dismissInApp();
                }, 6000);
            },

            dismissInApp: function() {
                clearTimeout(this._dismissTimer);
                var el = document.getElementById('inAppNotif');
                if (el) el.classList.remove('show');
                var self = this;
                setTimeout(function() { self._showNextInApp(); }, 400);
            },

            // ---- Test notification ----
            testNotification: function() {
                this.sendNotification('', 'Test Notification', 'Notifications are working! You\'ll receive reminders for water, meals, and health tips.', 'switchTab("health")');
            }
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Apply saved settings
            if (localStorage.getItem('snapchef_dark') === '1') {
                document.body.classList.add('dark-mode');
                var btn = document.getElementById('darkBtn');
                var btn2 = document.getElementById('darkBtn2');
                if (btn) btn.textContent = '';
                if (btn2) btn2.textContent = '';
            }

            // Load saved API key
            // (no longer needed - API key is on server)

            // Initialize systems
            setLanguage(currentLang);
            CreditSystem.init();
            MealPlanner.init();
            updatePremiumUI();
            checkDailyLimit();
            renderHistory();
            initVoice();
            updateOnlineStatus();

            // Event listeners
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);

            // Close dropdowns on outside click
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.lang-selector')) {
                    document.getElementById('langDropdown').classList.remove('show');
                }
            });

            // Hide splash
            hideSplash();

            // Init Health Target
            HealthTarget.init();

            // Init Notification System
            NotifSystem.init();
        });
    </script>
    <!-- Health Profile Setup Modal -->
    <div class="api-guide-modal" id="healthProfileModal">
        <div class="api-guide-content" style="max-width: 420px;">
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 50px;"></div>
                <h2 class="premium-title" style="margin-top: 10px;">Your Health Goal</h2>
                <p style="color: var(--text-muted); font-size: 13px;">Set your daily nutrition target</p>
            </div>

            <div class="profile-field">
                <label> What's your goal?</label>
                <div class="goal-options" id="goalOptions">
                    <div class="goal-option" data-goal="loss" onclick="HealthTarget.selectGoal('loss')">
                        <div class="goal-option-icon"></div>
                        <div class="goal-option-name">Lose Weight</div>
                        <div class="goal-option-desc">Cut calories</div>
                    </div>
                    <div class="goal-option" data-goal="maintain" onclick="HealthTarget.selectGoal('maintain')">
                        <div class="goal-option-icon"></div>
                        <div class="goal-option-name">Maintain</div>
                        <div class="goal-option-desc">Keep current</div>
                    </div>
                    <div class="goal-option" data-goal="gain" onclick="HealthTarget.selectGoal('gain')">
                        <div class="goal-option-icon"></div>
                        <div class="goal-option-name">Bulk Up</div>
                        <div class="goal-option-desc">Build muscle</div>
                    </div>
                    <div class="goal-option" data-goal="healthy" onclick="HealthTarget.selectGoal('healthy')">
                        <div class="goal-option-icon"></div>
                        <div class="goal-option-name">Eat Healthy</div>
                        <div class="goal-option-desc">Balanced diet</div>
                    </div>
                </div>
            </div>

            <div class="profile-field">
                <label> Daily calorie target</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="range" id="calorieSlider" min="1200" max="3500" value="2000" step="50" style="flex:1;" oninput="document.getElementById('calorieDisplay').textContent=this.value">
                    <span id="calorieDisplay" style="font-weight:700; font-size:18px; color:var(--primary); min-width:55px; text-align:center;">2000</span>
                    <span style="font-size:12px; color:#64748b;">kcal</span>
                </div>
            </div>

            <div class="profile-field">
                <label> Diet preference (optional)</label>
                <div class="diet-chips" id="dietChips">
                    <div class="diet-chip" onclick="HealthTarget.toggleDiet(this)" data-diet="balanced"> Balanced</div>
                    <div class="diet-chip" onclick="HealthTarget.toggleDiet(this)" data-diet="lowcarb"> Low Carb</div>
                    <div class="diet-chip" onclick="HealthTarget.toggleDiet(this)" data-diet="highprotein"> High Protein</div>
                    <div class="diet-chip" onclick="HealthTarget.toggleDiet(this)" data-diet="vegetarian"> Vegetarian</div>
                    <div class="diet-chip" onclick="HealthTarget.toggleDiet(this)" data-diet="mediterranean"> Mediterranean</div>
                    <div class="diet-chip" onclick="HealthTarget.toggleDiet(this)" data-diet="vegan"> Vegan</div>
                </div>
            </div>

            <div class="profile-field">
                <label> Daily water goal (glasses)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="range" id="waterSlider" min="4" max="15" value="8" step="1" style="flex:1;" oninput="document.getElementById('waterDisplay').textContent=this.value">
                    <span id="waterDisplay" style="font-weight:700; font-size:18px; color:#3b82f6; min-width:30px; text-align:center;">8</span>
                    <span style="font-size:16px;"></span>
                </div>
            </div>

            <button class="main-btn" onclick="HealthTarget.saveProfile()" style="margin-top: 10px; background: var(--secondary);">
                <span></span>
                <span>Save</span>
            </button>
            <button class="premium-close" onclick="document.getElementById('healthProfileModal').classList.remove('active')">Cancel</button>
        </div>
    </div>

</body>
</html>
